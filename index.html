<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FANTASYAS</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

  <style>
    :root {
      --bg: #000;
      --text: #fff;
      --text-secondary: #ccc;
      --card-bg: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.12);
      --input-bg: rgba(255,255,255,0.08);
      --input-border: rgba(255,255,255,0.18);
      --btn-bg: linear-gradient(to right,#333,#555);
      --btn-hover: linear-gradient(to right,#444,#666);
      --accent: #0af;
      --shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    body.light {
      --bg: #fff;
      --text: #111;
      --text-secondary: #555;
      --card-bg: rgba(0,0,0,0.04);
      --card-border: rgba(0,0,0,0.1);
      --input-bg: #fff;
      --input-border: #d0d0d0;
      --btn-bg: linear-gradient(to right,#ddd,#bbb);
      --btn-hover: linear-gradient(to right,#ccc,#aaa);
      --accent: #0066cc;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Manrope',sans-serif; }
    body { background:var(--bg); color:var(--text); min-height:100vh; transition:background 0.4s, color 0.4s; }

    .top-bar {
      position:fixed; top:0; left:0; right:0; height:70px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px);
      z-index:1000; transition:background 0.3s;
    }
    body.light .top-bar { background:rgba(255,255,255,0.92); }

    .site-name {
      font-size:1.8rem; font-weight:800;
      background:linear-gradient(90deg,#fff,#bbb);
      -webkit-background-clip:text; color:transparent; -webkit-text-fill-color:transparent;
    }
    body.light .site-name { background:linear-gradient(90deg,#111,#444); }

    .theme-toggle { cursor:pointer; font-size:1.5rem; margin-left:20px; }

    .burger { width:32px; height:24px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; }
    .burger span { height:3px; width:100%; background:var(--text); border-radius:2px; transition:all .35s; }
    .burger.active span:nth-child(1) { transform:rotate(45deg) translate(7px,7px); }
    .burger.active span:nth-child(2) { opacity:0; }
    .burger.active span:nth-child(3) { transform:rotate(-45deg) translate(6px,-6px); }

    .sidebar {
      position:fixed; top:0; left:-300px; width:280px; height:100%;
      background:rgba(0,0,0,0.5); backdrop-filter:blur(12px);
      padding:90px 28px; border-right:1px solid var(--card-border);
      transition:left .4s ease; z-index:900;
    }
    body.light .sidebar { background:rgba(255,255,255,0.5); }
    .sidebar.active { left:0; }

    .sidebar a {
      display:block; color:var(--text-secondary); text-decoration:none;
      font-size:1.22rem; font-weight:600; margin:1.4rem 0; transition:.25s;
    }
    .sidebar a:hover { color:var(--text); transform:translateX(8px); }

    .main-content { margin-top:90px; padding:20px; max-width:720px; margin-left:auto; margin-right:auto; }

    .section { display:none; opacity:0; transform:translateY(12px); transition:opacity 0.35s, transform 0.35s; }
    .section.active { display:block; opacity:1; transform:translateY(0); }

    .card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; padding:20px; margin-bottom:20px; transition:.2s; box-shadow:var(--shadow); }
    .card:hover { transform:scale(1.02); }

    input, textarea {
      width:100%; padding:12px 14px; border-radius:10px;
      border:1px solid var(--input-border); background:var(--input-bg);
      color:var(--text); font-size:1rem; outline:none; transition:.2s;
    }
    input:focus, textarea:focus { border-color:var(--accent); box-shadow:0 0 8px var(--accent); }
    textarea { resize:vertical; min-height:96px; }
    ::placeholder { color:var(--text-secondary); opacity:.7; }

    button {
      padding:11px 20px; border:none; border-radius:10px;
      background:var(--btn-bg); color:white; font-weight:700;
      cursor:pointer; transition:all .22s; box-shadow:var(--shadow);
    }
    button:hover { background:var(--btn-hover); opacity:.92; transform:scale(1.05); }
    button:active { transform:scale(0.97); }

    .feed { display:flex; flex-direction:column; gap:18px; }

    .post { background:var(--card-bg); border:1px solid var(--card-border); border-radius:12px; padding:16px; transition:all .5s; box-shadow:var(--shadow); }
    .post.show { animation: postShow 0.6s ease forwards; }

    @keyframes postShow {
      0% { opacity:0; transform:translateY(24px) scale(0.97); }
      60% { opacity:1; transform:translateY(-8px) scale(1.02); }
      100% { opacity:1; transform:translateY(0) scale(1); }
    }

    .post-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .avatar {
      width:48px; height:48px; border-radius:50%; background:#555;
      background-size:cover; background-position:center; flex-shrink:0;
      border:1px solid var(--card-border); transition:transform 0.2s;
    }
    .avatar:hover { transform:scale(1.1); }
    body.light .avatar { background:#ccc; }

    .username { font-weight:700; font-size:1.05rem; cursor:pointer; transition:color 0.2s; }
    .username:hover { color:var(--accent); }

    .post-content { line-height:1.5; word-break:break-word; color:var(--text); }

    .post-media img, .post-media video { width:100%; border-radius:12px; margin-top:12px; box-shadow:var(--shadow); }

    .post-footer { display:flex; gap:24px; margin-top:12px; }
    .post-footer button { background:none; color:var(--text-secondary); font-size:.95rem; padding:0; box-shadow:none; transition:all 0.2s; }
    .post-footer button:hover { color:var(--text); transform:scale(1.1); }
    .post-footer .like-btn { display:flex; align-items:center; gap:4px; }

    .comments { margin-top:16px; display:flex; flex-direction:column; gap:8px; }
    .comment { background:var(--input-bg); padding:8px 12px; border-radius:10px; font-size:0.95rem; }

    .emoji-panel {
      position:absolute; bottom:40px; left:0; background:var(--card-bg); border:1px solid var(--card-border);
      border-radius:12px; display:flex; gap:6px; padding:8px; opacity:0; transform:scale(0.7); pointer-events:none;
      transition:all 0.25s; z-index:100;
    }
    .emoji-panel.active { opacity:1; transform:scale(1); pointer-events:auto; }
    .emoji-panel span { cursor:pointer; font-size:1.4rem; transition:transform 0.15s; }
    .emoji-panel span:hover { transform:scale(1.3) rotate(10deg); animation:pulse 0.5s; }

    @keyframes pulse { 0% { transform:scale(1); } 50% { transform:scale(1.3); } 100% { transform:scale(1); } }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.75); display:none; align-items:center; justify-content:center; z-index:2000; opacity:0; transition:opacity 0.3s; }
    .modal.active { display:flex; opacity:1; }
    body.light .modal { background:rgba(255,255,255,0.75); }
    .modal-content { background:var(--card-bg); border:1px solid var(--card-border); color:var(--text); width:92%; max-width:520px; border-radius:16px; padding:28px 24px; position:relative; transform:scale(0.9); transition:transform 0.3s; }
    .modal.active .modal-content { transform:scale(1); }
    .modal-content h2 { color:var(--text); margin-bottom:20px; }
    .close-modal { position:absolute; top:16px; right:20px; font-size:2rem; cursor:pointer; color:var(--text-secondary); transition:color 0.2s; }
    .close-modal:hover { color:var(--text); }

    .chat-window { display:flex; flex-direction:column; height:400px; border:1px solid var(--card-border); border-radius:12px; overflow:hidden; box-shadow:var(--shadow); }
    .chat-header { padding:12px; border-bottom:1px solid var(--card-border); display:flex; align-items:center; gap:8px; }
    .chat-messages { flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; }
    .message { padding:8px 12px; border-radius:10px; max-width:80%; opacity:0; transform:translateY(12px); transition:all 0.3s; }
    .message.show { opacity:1; transform:translateY(0); }
    .message.sent { background:var(--accent); color:white; align-self:flex-end; }
    .message.received { background:var(--input-bg); align-self:flex-start; }
    .chat-input { display:flex; padding:12px; border-top:1px solid var(--card-border); }
    .chat-input input { flex:1; margin-right:8px; }
    .chat-input button { display:flex; align-items:center; gap:4px; }

    @media (max-width:900px) {
      .sidebar { width:100%; left:-100%; border-right:none; }
      .main-content { padding:16px; margin-top:80px; }
      .profile-header { flex-direction:column; align-items:center; text-align:center; }
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <div class="site-name">FANTASYAS</div>
    <span class="theme-toggle" onclick="toggleTheme()">üåô/‚òÄÔ∏è</span>
    <div class="burger" onclick="toggleSidebar()">
      <span></span><span></span><span></span>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <a href="#" onclick="showSection('auth')">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</a>
    <a href="#" onclick="showSection('feed')">–°—Ç—Ä—ñ—á–∫–∞</a>
    <a href="#" onclick="showSection('search')">–ü–æ—à—É–∫</a>
    <a href="#" onclick="showSection('profile')">–ü—Ä–æ—Ñ—ñ–ª—å</a>
    <a href="#" onclick="showSection('chats')">–ß–∞—Ç–∏</a>
    <a href="#" onclick="signOutUser()">–í–∏–π—Ç–∏</a>
  </div>

  <div class="main-content">

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è -->
    <div id="auth" class="section card">
      <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>
      <input id="email" placeholder="Email" type="email">
      <input id="password" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
      <button onclick="signUp()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
      <button onclick="signIn()">–£–≤—ñ–π—Ç–∏</button>
    </div>

    <!-- –°—Ç—Ä—ñ—á–∫–∞ -->
    <div id="feed" class="section feed active">
      <div class="card">
        <textarea id="postText" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
        <input id="postMedia" type="file" accept="image/*,video/*">
        <button onclick="createPost()">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
      </div>
      <div id="postsContainer"></div>
    </div>

    <!-- –ü–æ—à—É–∫ -->
    <div id="search" class="section">
      <input id="searchInput" placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤..." oninput="searchUsers()">
      <div id="userList" class="user-list"></div>
    </div>

    <!-- –ü—Ä–æ—Ñ—ñ–ª—å -->
    <div id="profile" class="section">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar" onclick="document.getElementById('avatarInput').click()"></div>
        <input id="avatarInput" type="file" accept="image/*" style="display:none" onchange="uploadAvatar()">
        <div>
          <h2 id="profileUsernameDisplay">@username</h2>
          <p id="profileBio">–ë—ñ–æ–≥—Ä–∞—Ñ—ñ—è...</p>
          <div>
            <span id="postsCount">–ü–æ—Å—Ç–∏: 0</span> ‚Ä¢
            <span id="followersCount">–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏: 0</span> ‚Ä¢
            <span id="followingCount">–ü—ñ–¥–ø–∏—Å–∫–∏: 0</span>
          </div>
          <button id="editProfileBtn" onclick="openEditProfileModal()">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
          <div id="otherProfileBtns"></div>
        </div>
      </div>
    </div>

    <!-- –ß–∞—Ç–∏ -->
    <div id="chats" class="section">
      <div id="chatList" class="chat-list"></div>
      <div id="chatWindow" class="chat-window" style="display:none;">
        <div id="chatHeader" class="chat-header"></div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input">
          <input id="chatInput" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...">
          <button onclick="sendMessage()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é -->
    <div id="editProfileModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('editProfileModal')">√ó</span>
        <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
        <input id="editNickname" placeholder="–ù—ñ–∫–Ω–µ–π–º">
        <textarea id="editBio" placeholder="–ë—ñ–æ"></textarea>
        <button onclick="saveProfile()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>

  </div>

  <script type="module">
    // Firebase Config (–∑–∞–º—ñ–Ω–∏ –Ω–∞ —Å–≤—ñ–π)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDoc, setDoc, updateDoc, doc, query, orderBy, onSnapshot, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;
    let unsubscribeFeed = null;
    let unsubscribeChat = null;
    let currentChatPartner = null;
    let currentProfileUid = null;

    // –¢–µ–º–∞
    function toggleTheme() {
      document.body.classList.toggle('light');
      localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
    }
    if (localStorage.getItem('theme') === 'light') toggleTheme();

    // –°–∞–π–¥–±–∞—Ä
    function toggleSidebar() {
      document.querySelector('.burger').classList.toggle('active');
      document.getElementById('sidebar').classList.toggle('active');
    }

    // –ü–æ–∫–∞–∑ —Å–µ–∫—Ü—ñ—ó
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      toggleSidebar();
      if (sectionId === 'profile') openUserProfile(currentUser.uid);
      if (sectionId === 'chats') loadChats();
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        document.getElementById('auth').style.display = 'none';
        showSection('feed');
        subscribeToFeed();
      } else {
        showSection('auth');
      }
    });

    window.signUp = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', cred.user.uid), {
          nickname: email.split('@')[0],
          bio: '',
          avatar: '',
          followers: [],
          following: [],
          posts: []
        });
      } catch (e) { alert(e.message); }
    };

    window.signIn = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) { alert(e.message); }
    };

    window.signOutUser = () => signOut(auth);

    // –°—Ç—Ä—ñ—á–∫–∞ –ø–æ—Å—Ç—ñ–≤
    function subscribeToFeed() {
      if (unsubscribeFeed) unsubscribeFeed();
      const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
      unsubscribeFeed = onSnapshot(q, snapshot => {
        const container = document.getElementById('postsContainer');
        container.innerHTML = '';
        let delay = 0;
        snapshot.forEach(docSnap => {
          const post = docSnap.data();
          const postEl = document.createElement('div');
          postEl.className = 'post';
          postEl.innerHTML = `
            <div class="post-header">
              <div class="avatar" style="background-image:url(${post.authorAvatar || ''})" onclick="openUserProfile('${post.authorUid}')"></div>
              <div class="username" onclick="openUserProfile('${post.authorUid}')">@${post.authorNickname}</div>
              ${post.authorUid === currentUser.uid ? `<button class="menu-btn">‚ãØ</button>` : ''}
            </div>
            <div class="post-content">${post.text.replace(/\n/g, '<br>')}</div>
            ${post.mediaUrl ? (post.mediaType === 'video' ? `<video src="${post.mediaUrl}" controls class="post-media"></video>` : `<img src="${post.mediaUrl}" class="post-media">`) : ''}
            <div class="post-footer">
              <button class="like-btn ${post.likes?.includes(currentUser.uid) ? 'liked' : ''}" onclick="toggleLike('${docSnap.id}')">
                ‚ù§Ô∏è ${post.likes?.length || 0}
              </button>
              <button onclick="toggleComments('${docSnap.id}')">üí¨ ${post.comments?.length || 0}</button>
              <button class="emoji-btn">üòÄ</button>
            </div>
            <div class="emoji-panel"></div>
            <div id="comments-${docSnap.id}" class="comments" style="display:none;"></div>
          `;
          container.appendChild(postEl);
          postEl.classList.add('show');
          postEl.style.animationDelay = `${delay}ms`;
          delay += 80;

          // –ï–º–æ–¥–∑—ñ
          const emojiBtn = postEl.querySelector('.emoji-btn');
          emojiBtn.onclick = () => {
            const panel = postEl.querySelector('.emoji-panel');
            if (!panel.innerHTML) {
              panel.innerHTML = ['üòÄ','üòÇ','üòç','üò¢','üò°','üëç','üëé'].map(em => `<span onclick="addReaction('${docSnap.id}', '${em}')">${em}</span>`).join('');
            }
            panel.classList.toggle('active');
          };
        });
      });
    }

    window.toggleLike = async (postId) => {
      const postRef = doc(db, 'posts', postId);
      const snap = await getDoc(postRef);
      const likes = snap.data().likes || [];
      if (likes.includes(currentUser.uid)) {
        await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
      } else {
        await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
      }
    };

    window.addReaction = async (postId, emoji) => {
      const postRef = doc(db, 'posts', postId);
      await updateDoc(postRef, { reactions: arrayUnion({ uid: currentUser.uid, emoji }) });
      // –¢—É—Ç –º–æ–∂–Ω–∞ –æ–Ω–æ–≤–∏—Ç–∏ UI —Ä–µ–∞–∫—Ü—ñ–π
    };

    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å—Ç–∞
    window.createPost = async () => {
      const text = document.getElementById('postText').value;
      if (!text) return alert('–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç');
      let mediaUrl = '', mediaType = '';
      const file = document.getElementById('postMedia').files[0];
      if (file) {
        const storageRef = ref(storage, `media/${currentUser.uid}/${Date.now()}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
        mediaType = file.type.startsWith('video') ? 'video' : 'image';
      }
      const userSnap = await getDoc(doc(db, 'users', currentUser.uid));
      const user = userSnap.data();
      await addDoc(collection(db, 'posts'), {
        text,
        authorUid: currentUser.uid,
        authorNickname: user.nickname,
        authorAvatar: user.avatar,
        mediaUrl,
        mediaType,
        likes: [],
        comments: [],
        reactions: [],
        createdAt: serverTimestamp()
      });
      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
    };

    // –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ (–ø—Ä–∏–∫–ª–∞–¥, —Ä–æ–∑—à–∏—Ä—å –∑–∞ –ø–æ—Ç—Ä–µ–±–æ—é)
    window.toggleComments = (postId) => {
      const commentsDiv = document.getElementById(`comments-${postId}`);
      commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
      // –ó–∞–≤–∞–Ω—Ç–∞–∂ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –∑ –ø—ñ–¥–∫–æ–ª–µ–∫—Ü—ñ—ó —ñ –¥–æ–¥–∞–π —Ñ–æ—Ä–º—É –¥–æ–¥–∞–≤–∞–Ω–Ω—è
    };

    // –ü—Ä–æ—Ñ—ñ–ª—å
    window.openUserProfile = async (uid) => {
      currentProfileUid = uid;
      showSection('profile');
      const userSnap = await getDoc(doc(db, 'users', uid));
      const data = userSnap.data();
      document.getElementById('profileUsernameDisplay').textContent = `@${data.nickname}`;
      document.getElementById('profileBio').textContent = data.bio || '–ù–µ–º–∞—î –±—ñ–æ';
      document.getElementById('profileAvatar').style.backgroundImage = `url(${data.avatar || ''})`;
      document.getElementById('postsCount').textContent = `–ü–æ—Å—Ç–∏: ${data.posts?.length || 0}`;
      document.getElementById('followersCount').textContent = `–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏: ${data.followers?.length || 0}`;
      document.getElementById('followingCount').textContent = `–ü—ñ–¥–ø–∏—Å–∫–∏: ${data.following?.length || 0}`;

      if (uid === currentUser.uid) {
        document.getElementById('editProfileBtn').style.display = 'block';
        const btns = document.getElementById('otherProfileBtns');
        if (btns) btns.innerHTML = '';
      } else {
        document.getElementById('editProfileBtn').style.display = 'none';
        let btnContainer = document.getElementById('otherProfileBtns');
        if (!btnContainer) {
          btnContainer = document.createElement('div');
          btnContainer.id = 'otherProfileBtns';
          btnContainer.style.display = 'flex';
          btnContainer.style.gap = '12px';
          btnContainer.style.marginTop = '12px';
          document.querySelector('.profile-header').appendChild(btnContainer);
        }
        btnContainer.innerHTML = '';
        const followBtn = document.createElement('button');
        const isFollowing = data.followers.includes(currentUser.uid);
        followBtn.textContent = isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';
        followBtn.onclick = async () => {
          await toggleFollow(uid);
          openUserProfile(uid);
        };
        btnContainer.appendChild(followBtn);

        const messageBtn = document.createElement('button');
        messageBtn.textContent = '–ù–∞–ø–∏—Å–∞—Ç–∏';
        messageBtn.onclick = () => openChat(data.nickname, uid);
        btnContainer.appendChild(messageBtn);
      }
    };

    window.toggleFollow = async (uid) => {
      const userRef = doc(db, 'users', uid);
      const myRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.data().followers.includes(currentUser.uid)) {
        await updateDoc(userRef, { followers: arrayRemove(currentUser.uid) });
        await updateDoc(myRef, { following: arrayRemove(uid) });
      } else {
        await updateDoc(userRef, { followers: arrayUnion(currentUser.uid) });
        await updateDoc(myRef, { following: arrayUnion(uid) });
      }
    };

    window.openEditProfileModal = () => {
      const modal = document.getElementById('editProfileModal');
      modal.classList.add('active');
      document.getElementById('editNickname').value = document.getElementById('profileUsernameDisplay').textContent.slice(1);
      document.getElementById('editBio').value = document.getElementById('profileBio').textContent;
    };

    window.closeModal = (id) => document.getElementById(id).classList.remove('active');

    window.saveProfile = async () => {
      const nickname = document.getElementById('editNickname').value;
      const bio = document.getElementById('editBio').value;
      await updateDoc(doc(db, 'users', currentUser.uid), { nickname, bio });
      closeModal('editProfileModal');
      openUserProfile(currentUser.uid);
    };

    window.uploadAvatar = async () => {
      const file = document.getElementById('avatarInput').files[0];
      if (file) {
        const storageRef = ref(storage, `avatars/${currentUser.uid}`);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        await updateDoc(doc(db, 'users', currentUser.uid), { avatar: url });
        openUserProfile(currentUser.uid);
      }
    };

    // –ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
    window.searchUsers = async () => {
      const queryText = document.getElementById('searchInput').value.toLowerCase();
      const q = query(collection(db, 'users'));
      const snapshot = await getDocs(q);
      const list = document.getElementById('userList');
      list.innerHTML = '';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.nickname.toLowerCase().includes(queryText)) {
          const item = document.createElement('div');
          item.className = 'user-item';
          item.innerHTML = `
            <div class="avatar" style="background-image:url(${data.avatar || ''})"></div>
            <div class="name">@${data.nickname}</div>
          `;
          item.onclick = () => openUserProfile(docSnap.id);
          list.appendChild(item);
        }
      });
    };

    // –ß–∞—Ç–∏
    function loadChats() {
      // –ó–∞–≤–∞–Ω—Ç–∞–∂ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤ (–ø—Ä–∏–∫–ª–∞–¥: –∑ following)
    }

    window.openChat = (name, uid) => {
      currentChatPartner = uid;
      document.getElementById('chatWindow').style.display = 'flex';
      document.getElementById('chatHeader').innerHTML = `<div class="name">@${name}</div>`;
      subscribeToChat(uid);
    };

    function subscribeToChat(otherUid) {
      if (unsubscribeChat) unsubscribeChat();
      const chatId = [currentUser.uid, otherUid].sort().join('_');
      const q = query(collection(db, `chats/${chatId}/messages`), orderBy('createdAt'));
      const messagesDiv = document.getElementById('chatMessages');
      unsubscribeChat = onSnapshot(q, snap => {
        messagesDiv.innerHTML = '';
        snap.forEach(m => {
          const msg = m.data();
          const div = document.createElement('div');
          div.className = `message ${msg.from === currentUser.uid ? 'sent' : 'received'}`;
          div.textContent = msg.text;
          messagesDiv.appendChild(div);
          setTimeout(() => div.classList.add('show'), 50);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    window.sendMessage = async () => {
      const text = document.getElementById('chatInput').value;
      if (!text) return;
      const chatId = [currentUser.uid, currentChatPartner].sort().join('_');
      await addDoc(collection(db, `chats/${chatId}/messages`), {
        text,
        from: currentUser.uid,
        createdAt: serverTimestamp()
      });
      document.getElementById('chatInput').value = '';
    };

  </script>
</body>
</html>
