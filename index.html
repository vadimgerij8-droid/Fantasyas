<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FANTASYAS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #111111;
      --surface-hover: #1a1a1a;
      --border: #222222;
      --text-primary: #e0e0e0;
      --text-secondary: #888888;
      --accent: #cccccc;
      --accent-hover: #ffffff;
      --danger: #ff4d4d;
      --radius: 12px;
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 0 16px;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
    }

    .top-bar {
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
    }

    .logo {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      background: linear-gradient(90deg, #ccc, #fff);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    button,
    .btn {
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 18px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      user-select: none;
    }

    button:hover,
    .btn:hover {
      background: var(--surface-hover);
      border-color: var(--accent);
    }

    button:active,
    .btn:active {
      transform: scale(0.97);
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.12);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
      pointer-events: none;
    }

    button:active::before {
      width: 300%;
      height: 300%;
    }

    .btn-primary {
      background: var(--accent);
      color: #000;
      border: none;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin: 16px 0;
    }

    input, textarea {
      width: 100%;
      padding: 12px 16px;
      background: #0f0f0f;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 1rem;
      transition: var(--transition);
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(204,204,204,0.1);
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #222;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }

    .post {
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .username {
      font-weight: 600;
      color: var(--text-primary);
    }

    .user-id {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .post-content {
      margin: 8px 0 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .post-actions {
      display: flex;
      gap: 24px;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .action-btn {
      background: none;
      border: none;
      color: inherit;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: var(--transition);
    }

    .action-btn:hover {
      color: var(--accent);
    }

    .liked {
      color: #ff4d4d !important;
    }

    .auth-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 32px 16px;
    }

    .auth-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px 24px;
      max-width: 420px;
      width: 100%;
      margin: 0 auto;
    }

    .auth-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 24px;
      text-align: center;
    }

    .google-btn {
      background: #ffffff;
      color: #000;
      border: none;
      width: 100%;
      margin: 12px 0;
      font-weight: 500;
    }

    .google-btn svg {
      width: 20px;
      height: 20px;
    }

    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      backdrop-filter: blur(12px);
    }

    .tab-item {
      flex: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.75rem;
      gap: 4px;
      transition: var(--transition);
    }

    .tab-item.active {
      color: var(--accent);
    }

    .tab-icon {
      width: 24px;
      height: 24px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    @media (min-width: 768px) {
      .container { max-width: 680px; padding: 0 24px; }
      .auth-card { padding: 40px 32px; }
    }
  </style>
</head>
<body>

<!-- Auth Screen -->
<div id="authScreen" class="auth-screen">
  <div class="auth-card">
    <h1 class="auth-title">FANTASYAS</h1>
    
    <button id="googleLoginBtn" class="btn google-btn" style="display:flex;align-items:center;justify-content:center;gap:12px;">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.51h5.84c-.25 1.31-.98 2.42-2.07 3.16v2.63h3.35c1.96-1.81 3.1-4.47 3.1-7.8z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-1.01 7.28-2.73l-3.35-2.63c-1.01.68-2.29 1.08-3.93 1.08-3.02 0-5.58-2.04-6.49-4.79H.96v2.67C2.77 20.39 6.62 23 12 23z"/><path fill="#FBBC05" d="M5.51 14.21c-.23-.68-.36-1.41-.36-2.21s.13-1.53.36-2.21V7.34H.96C.35 8.85 0 10.39 0 12s.35 3.15.96 4.66l4.55-2.45z"/><path fill="#EA4335" d="M12 4.98c1.64 0 3.11.56 4.27 1.66l3.19-3.19C17.46 1.01 14.97 0 12 0 6.62 0 2.77 2.61 0.96 6.34l4.55 2.45C6.42 6.02 8.98 4.98 12 4.98z"/></svg>
      Увійти через Google
    </button>

    <div style="margin: 24px 0; text-align:center; color:var(--text-secondary);">або</div>

    <input type="text" id="nickname" placeholder="Псевдонім (без @)" autocomplete="off" />
    <input type="password" id="password" placeholder="Пароль" style="margin:12px 0;" />
    
    <button id="loginBtn" class="btn" style="width:100%;">Увійти</button>
    <button id="registerBtn" class="btn" style="width:100%;margin-top:12px;">Зареєструватися</button>
  </div>
</div>

<!-- Main App (приховане спочатку) -->
<div id="app" style="display:none;">
  <header>
    <div class="top-bar">
      <div class="logo">FANTASYAS</div>
      <button id="logoutBtn" class="btn" style="padding:8px 16px;font-size:0.9rem;">Вийти</button>
    </div>
  </header>

  <div class="container">
    <!-- New Post -->
    <div class="card" id="newPostCard">
      <textarea id="postText" rows="3" placeholder="Що у тебе нового?"></textarea>
      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
        <input type="file" id="postMedia" accept="image/*,video/*" style="font-size:0.9rem;color:var(--text-secondary);" />
        <button id="addPost" class="btn btn-primary">Опублікувати</button>
      </div>
    </div>

    <!-- Feed -->
    <div id="feed"></div>
  </div>

  <!-- Bottom Tab Bar -->
  <div class="tab-bar">
    <button class="tab-item active" data-tab="home">
      <svg class="tab-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      Головна
    </button>
    <button class="tab-item" data-tab="search">
      <svg class="tab-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Пошук
    </button>
    <button class="tab-item" data-tab="profile">
      <svg class="tab-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Профіль
    </button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "satinov.pages.dev",           // !!!! ВАЖЛИВО — твій реальний домен
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.appspot.com",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const googleProvider = new GoogleAuthProvider();

  // Обробка результату після редиректу
  getRedirectResult(auth).then((result) => {
    if (result?.user) {
      handleUser(result.user);
    }
  }).catch(console.error);

  // Слухач стану авторизації
  onAuthStateChanged(auth, (user) => {
    if (user) {
      handleUser(user);
    } else {
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
    }
  });

  async function handleUser(user) {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';

    // Перевіряємо чи є користувач у базі
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      const nickname = user.displayName?.split(' ')[0] || user.email?.split('@')[0] || 'user';
      let userId = `@${nickname.toLowerCase()}`;
      
      // Перевіряємо унікальність userId
      const q = query(collection(db, "users"), where("userId", "==", userId));
      const existing = await getDocs(q);
      if (!existing.empty) {
        userId += Math.floor(Math.random() * 1000);
      }

      await setDoc(userRef, {
        uid: user.uid,
        nickname,
        userId,
        email: user.email,
        avatar: user.photoURL || '',
        createdAt: serverTimestamp()
      });
    }

    loadFeed();
  }

  // Google Login
  document.getElementById('googleLoginBtn')?.addEventListener('click', () => {
    signInWithRedirect(auth, googleProvider);
  });

  // Простий логін (можна розширити)
  document.getElementById('loginBtn')?.addEventListener('click', async () => {
    alert('Логін через email/пароль поки не реалізовано в цій версії');
  });

  document.getElementById('registerBtn')?.addEventListener('click', async () => {
    alert('Реєстрація поки не реалізовано в цій версії');
  });

  // Вихід
  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    signOut(auth);
  });

  // Завантаження стрічки
  async function loadFeed() {
    const feed = document.getElementById('feed');
    feed.innerHTML = '<div style="text-align:center;padding:40px 0;color:var(--text-secondary);">Завантаження...</div>';

    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(10));
    const snapshot = await getDocs(q);

    feed.innerHTML = '';

    snapshot.forEach(doc => {
      const post = doc.data();
      const postEl = document.createElement('div');
      postEl.className = 'post';
      postEl.innerHTML = `
        <div class="post-header">
          <div class="avatar" style="background-image:url('${post.avatar || ''}')"></div>
          <div>
            <div class="username">${post.nickname || 'Анонім'}</div>
            <div class="user-id">${post.userId || ''}</div>
          </div>
        </div>
        <div class="post-content">${post.text || ''}</div>
        ${post.mediaUrl ? `<img src="${post.mediaUrl}" style="width:100%;border-radius:${var(--radius)};margin-top:12px;">` : ''}
        <div class="post-actions">
          <button class="action-btn"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg> ${post.likesCount || 0}</button>
          <button class="action-btn"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> ${post.commentsCount || 0}</button>
        </div>
      `;
      feed.appendChild(postEl);
    });
  }

  // Додавання посту
  document.getElementById('addPost')?.addEventListener('click', async () => {
    const text = document.getElementById('postText').value.trim();
    if (!text) return alert('Напишіть щось');

    const user = auth.currentUser;
    if (!user) return;

    const userSnap = await getDoc(doc(db, "users", user.uid));
    const userData = userSnap.data();

    await addDoc(collection(db, "posts"), {
      text,
      author: user.uid,
      nickname: userData.nickname,
      userId: userData.userId,
      avatar: userData.avatar,
      createdAt: serverTimestamp(),
      likesCount: 0,
      commentsCount: 0
    });

    document.getElementById('postText').value = '';
    loadFeed();
  });
</script>
</body>
</html>
