<!DOCTYPE html><html lang="uk"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/><title>FANTASYAS</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/><style>:root{--bg:#fff;--surface:#f5f5f5;--card:#fff;--border:#e0e0e0;--text1:#000;--text2:#333;--text3:#666;--accent:#000;--accent-hover:#333;--danger:red;--success:green;--like:#ff3040;--save:#fbbf24;--shadow:0 2px 8px #0000000d;--radius:12px;--sidebar:280px;--header:64px}body.dark{--bg:#000;--surface:#1a1a1a;--card:#222;--border:#333;--text1:#fff;--text2:#ccc;--text3:#999;--accent:#fff;--accent-hover:#ccc;--danger:#ff4444;--success:#4caf50;--like:#ff6b7c;--save:#fcd34d}*{margin:0;padding:0;box-sizing:border-box;font-family:Inter,sans-serif;-webkit-tap-highlight-color:transparent}body{background:var(--bg);color:var(--text1);min-height:100vh;transition:.3s}.tv-mode :focus{outline:0!important;transform:scale(1.05);box-shadow:0 0 0 4px var(--text1)!important;z-index:10}.app{display:flex;height:100vh;overflow:hidden}.sidebar{width:var(--sidebar);background:rgba(255,255,255,.7);backdrop-filter:blur(12px);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:24px 0;transition:transform .4s;z-index:1000;position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);box-shadow:0 8px 24px #0000001f;border-radius:0 20px 20px 0}.dark .sidebar{background:rgba(0,0,0,.7)}.sidebar.open{transform:translateX(0)}.sidebar-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:999}.sidebar-backdrop.active{display:block}.sidebar-header{padding:0 20px 20px;border-bottom:1px solid var(--border)}.logo{font-size:1.8rem;font-weight:700;letter-spacing:-1px;color:var(--text1);text-transform:uppercase}.nav{flex:1;display:flex;flex-direction:column;padding:16px 0}.nav-item{display:flex;align-items:center;gap:14px;padding:14px 20px;margin:4px 12px;border-radius:var(--radius);color:var(--text2);transition:.3s;cursor:pointer;font-weight:500;border:1px solid transparent}.nav-item:hover{color:var(--accent);transform:translateX(4px)}.nav-item.active{background:var(--accent);color:var(--bg);border-color:var(--accent)}.nav-item .icon{width:24px;height:24px;stroke:currentColor;stroke-width:1.8;fill:none}.nav-item .badge{margin-left:auto;background:var(--accent);color:var(--bg);padding:4px 8px;border-radius:40px;font-size:.8rem}.main{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}.top-bar{height:var(--header);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:12px;position:sticky;top:0;z-index:100;backdrop-filter:blur(8px);background:rgba(255,255,255,.8)}.dark .top-bar{background:rgba(0,0,0,.8)}.menu-toggle{display:flex;width:40px;height:30px;flex-direction:column;justify-content:space-between;cursor:pointer;padding:5px 0}.menu-toggle span{height:2px;width:100%;background:var(--text1);border-radius:2px;transition:.3s}.menu-toggle.active span:nth-child(1){transform:rotate(45deg) translate(8px,8px)}.menu-toggle.active span:nth-child(2){opacity:0}.menu-toggle.active span:nth-child(3){transform:rotate(-45deg) translate(8px,-8px)}.top-bar-title{font-size:1.4rem;font-weight:600;color:var(--text1)}.content{flex:1;overflow-y:auto;padding:16px;scroll-behavior:smooth}.section{display:none;animation:fadeSlideIn .3s}.section.active{display:block}@keyframes fadeSlideIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.emoji-picker-container{position:relative;display:inline-block}.emoji-button{background:0 0;border:none;font-size:1.8rem;cursor:pointer;padding:8px;color:var(--text1);min-width:44px;min-height:44px;border-radius:50%}.emoji-picker{position:absolute;bottom:100%;right:0;width:320px;max-height:400px;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px #0000001f;z-index:2000;display:flex;flex-direction:column;padding:10px;backdrop-filter:blur(10px)}.tv-mode .emoji-picker{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:600px;height:80vh;z-index:10000}.emoji-picker .emoji-search{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface);color:var(--text1);margin-bottom:8px}.emoji-picker .emoji-categories{display:flex;gap:4px;overflow-x:auto;padding-bottom:8px;border-bottom:1px solid var(--border)}.emoji-picker .emoji-category{padding:6px 12px;background:var(--surface);border-radius:30px;font-size:.9rem;cursor:pointer;color:var(--text2)}.emoji-picker .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;overflow-y:auto;padding:4px 0;max-height:200px}.emoji-picker .emoji-grid span{font-size:1.5rem;text-align:center;cursor:pointer;padding:4px;border-radius:8px}.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:var(--shadow);margin-bottom:16px}.avatar{width:56px;height:56px;border-radius:50%;background:var(--surface);background-size:cover;background-position:center;border:1px solid var(--border);cursor:pointer;flex-shrink:0}.avatar.small{width:40px;height:40px}.avatar.large{width:80px;height:80px}.online-indicator{display:inline-block;width:10px;height:10px;background:var(--success);border-radius:50%;border:1px solid var(--card);margin-left:6px;animation:pulse 1.5s infinite}@keyframes pulse{0%{opacity:1}50%{opacity:.5}to{opacity:1}}.btn{padding:12px 20px;border-radius:var(--radius);background:var(--surface);border:1px solid var(--border);color:var(--text1);font-weight:500;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px;font-size:.95rem;min-height:44px}.btn:hover{background:var(--accent);color:var(--bg);border-color:var(--accent);transform:translateY(-2px)}.btn-primary{background:var(--accent);color:var(--bg)}.btn-danger{background:var(--danger);color:#fff}.input{width:100%;padding:14px 18px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--text1);font-size:1rem;outline:0;min-height:48px}.input:focus{border-color:var(--accent);box-shadow:0 0 0 2px #0000001a}.file-input-wrapper{position:relative;display:inline-block;width:100%}.file-input-wrapper input[type=file]{position:absolute;top:0;left:0;opacity:0;width:100%;height:100%;cursor:pointer;z-index:2}.file-input-button{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;background:var(--surface);border:1px dashed var(--border);border-radius:var(--radius);color:var(--text2);transition:.2s;min-height:48px}.file-preview{margin-top:12px;max-width:100%;max-height:200px;border-radius:8px;object-fit:cover;display:none}.file-preview.show{display:block}.feed{display:flex;flex-direction:column;gap:16px}.post{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:var(--shadow);position:relative;animation:fadeIn .4s}@keyframes fadeIn{0%{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}.post-header{display:flex;gap:12px;margin-bottom:12px}.post-author{font-weight:600;font-size:1.1rem;cursor:pointer;color:var(--text1)}.post-meta,.post-time{color:var(--text3);font-size:.9rem}.post-time{margin-left:auto}.post-actions{position:absolute;top:16px;right:16px}.post-actions button{background:0 0;border:none;color:var(--text2);font-size:1.4rem;padding:8px;border-radius:50%;min-width:44px;min-height:44px;cursor:pointer}.hashtag-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}.hashtag{color:var(--text1);font-weight:500;cursor:pointer;border-bottom:1px dashed var(--text3)}.post-media{width:100%;border-radius:var(--radius);margin:12px 0;max-height:300px;object-fit:cover;filter:grayscale(100%);transition:.3s}.post-media:hover{filter:grayscale(0);transform:scale(1.02)}.post-footer{display:flex;gap:16px;padding-top:12px;border-top:1px solid var(--border);align-items:center}.post-footer button{background:0 0;border:none;display:flex;align-items:center;gap:6px;color:var(--text2);cursor:pointer;font-size:.9rem;padding:8px;min-height:44px}.post-footer button.liked{color:var(--like)}.post-footer button.saved{color:var(--save)}.view-count{display:flex;align-items:center;gap:4px;color:var(--text3);font-size:.9rem;margin-left:auto}.comments-section{overflow:hidden;transition:max-height .4s,padding .3s;max-height:2000px;margin-top:16px;border-top:1px solid var(--border);padding-top:16px}.comments-section.collapsed{max-height:0;padding:0;border-top:none;margin-top:0}.comment{margin-bottom:16px}.comment-main{display:flex;gap:10px}.comment-avatar{width:36px;height:36px;border-radius:50%;background-size:cover;border:1px solid var(--border)}.comment-content{flex:1;background:var(--surface);padding:10px 14px;border-radius:12px}.comment-author{font-weight:600;cursor:pointer;color:var(--text1)}.comment-text{color:var(--text2)}.comment-time{font-size:.8rem;color:var(--text3)}.chat-item{display:flex;align-items:center;gap:14px;padding:16px;border-radius:12px;background:var(--card);border:1px solid var(--border);cursor:pointer;margin-bottom:8px}.chat-item.unread{border-left:4px solid var(--accent)}.chat-name{font-weight:600;color:var(--text1)}.chat-badge{background:var(--accent);color:var(--bg);border-radius:50%;min-width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:.85rem}.chat-window{display:flex;flex-direction:column;height:100%;background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}.chat-messages{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:12px}.message-bubble{max-width:80%;padding:12px 16px;border-radius:18px;word-break:break-word;font-size:.95rem}.message-bubble.sent{background:var(--accent);color:var(--bg);border-bottom-right-radius:4px}.message-bubble.received{background:var(--surface);color:var(--text1);border:1px solid var(--border);border-bottom-left-radius:4px}.chat-input-area{display:flex;padding:12px;border-top:1px solid var(--border);gap:8px;flex-wrap:wrap;background:var(--surface)}.profile-header{display:flex;gap:20px;margin-bottom:24px;flex-wrap:wrap}.profile-stats{display:flex;gap:20px;margin:16px 0}.profile-stats span{cursor:pointer;color:var(--text2)}.profile-tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:20px;overflow-x:auto}.profile-tab{padding:10px 20px;border-radius:var(--radius);cursor:pointer;color:var(--text2);min-height:44px;border:1px solid transparent}.profile-tab.active{background:var(--accent);color:var(--bg)}.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:2000;padding:16px}.modal.active{display:flex}.modal-content{background:var(--card);border-radius:16px;padding:24px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}#toast{position:fixed;bottom:20px;left:16px;right:16px;background:var(--accent);color:var(--bg);padding:14px 20px;border-radius:60px;box-shadow:0 8px 24px #0000001f;z-index:3000;opacity:0;transition:.3s;text-align:center}#toast.show{opacity:1}.tv-remote{position:fixed;bottom:20px;right:20px;background:rgba(0,0,0,.7);color:#fff;padding:12px 18px;border-radius:40px;font-size:.9rem;backdrop-filter:blur(4px);z-index:10000;display:none;gap:16px;border:1px solid rgba(255,255,255,.3)}.tv-mode .tv-remote{display:flex}</style></head><body><div class=app><div class="sidebar-backdrop" id=sdB></div><aside class=sidebar id=sd><div class=sidebar-header><div class=logo>FANTASYAS</div></div><nav class=nav id=nav><div class="nav-item active" data-sec=home><svg class=icon viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>–ì–æ–ª–æ–≤–Ω–∞</span></div><div class=nav-item data-sec=search><svg class=icon viewBox="0 0 24 24"><circle cx=11 cy=11 r=8/><line x1=21 y1=21 x2=16.65 y2=16.65/></svg><span>–ü–æ—à—É–∫</span></div><div class=nav-item data-sec=hashtags><svg class=icon viewBox="0 0 24 24"><path d="M4 9h16M4 15h16M10 3L8 21M16 3l-2 21"/></svg><span>–•–µ—à—Ç–µ–≥–∏</span></div><div class=nav-item data-sec=profile><svg class=icon viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx=12 cy=7 r=4/></svg><span>–ü—Ä–æ—Ñ—ñ–ª—å</span></div><div class=nav-item data-sec=chats><svg class=icon viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>–ß–∞—Ç–∏</span><span class=badge id=unread style=display:none>0</span></div></nav><div class=sidebar-footer><div class=nav-item data-sec=settings><svg class=icon viewBox="0 0 24 24"><circle cx=12 cy=12 r=3/><path d="M19.4 15a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H5.78a1.65 1.65 0 0 0-1.51 1 1.65 1.65 0 0 0 .33 1.82l.07.07A10 10 0 0 0 12 17.66a10 10 0 0 0 6.26-2.26z"/></svg><span>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span></div></div></aside><main class=main><div class=top-bar><div class=menu-toggle id=menu><span></span><span></span><span></span></div><div class=top-bar-title id=pt>–ì–æ–ª–æ–≤–Ω–∞</div></div><div class=content id=cont><div id=home class="section active"><div class=card id=auth><div id=login><input type=text id=loginNick class=input placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)"><input type=password id=loginPass class=input placeholder=–ü–∞—Ä–æ–ª—å><button class="btn btn-primary" id=loginBtn style="width:100%;margin-top:12px">–£–≤—ñ–π—Ç–∏</button><div style="display:flex;gap:12px;margin-top:16px"><button class=btn id=googleBtn style=flex:1>Google</button><button class=btn id=appleBtn style=flex:1>Apple</button></div><p style=margin-top:20px>–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id=toReg style="color:var(--text1);cursor:pointer">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p><p><a href=# id=forgotPass style="color:var(--text1)">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</a></p></div><div id=reg style=display:none><input type=text id=regNick class=input placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)"><input type=password id=regPass class=input placeholder=–ü–∞—Ä–æ–ª—å><button class="btn btn-primary" id=regBtn style="width:100%;margin-top:12px">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button><p style=margin-top:20px>–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id=toLog style="color:var(--text1);cursor:pointer">–£–≤—ñ–π—Ç–∏</span></p></div></div><div class=card id=newPost style=display:none><div style="display:flex;gap:10px;margin-bottom:12px"><textarea id=postText class=input placeholder="–©–æ –Ω–æ–≤–æ–≥–æ? #—Ö–µ—à—Ç–µ–≥" rows=2 style=flex:1></textarea><div class=emoji-picker-container><button class=emoji-button id=postEmoji>üòä</button><div class=emoji-picker id=postEmojiP style=display:none></div></div></div><div class=file-input-wrapper><input type=file id=postMedia accept=image/*,video/*><div class=file-input-button><svg width=22 height=22 viewBox="0 0 24 24" fill=none stroke=currentColor><rect x=2 y=2 width=20 height=20 rx=2.18/><circle cx=7.5 cy=7.5 r=1.5/><polyline points="21 15 16 10 5 21"/></svg><span id=postMediaLabel>–û–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ</span></div></div><img id=postMediaPrev class=file-preview><button class="btn btn-primary" id=addPost style=margin-top:12px>–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button></div><div style="display:flex;gap:12px;margin-bottom:16px"><button class=btn id=feedNew style=flex:1>–ù–æ–≤—ñ</button><button class=btn id=feedPop style=flex:1>–ü–æ–ø—É–ª—è—Ä–Ω—ñ</button></div><div class=feed id=feed></div><div id=feedSentinel></div><div id=skeleton style=display:none><div class=skeleton style=height:200px;margin-bottom:16px></div><div class=skeleton style=height:200px></div></div></div><div id=search class=section><input type=text id=searchIn class=input placeholder="–ü–æ—à—É–∫ –∑–∞ @id, —ñ–º'—è–º –∞–±–æ #—Ö–µ—à—Ç–µ–≥–æ–º..."><div class=user-list id=userList style=margin-top:16px></div></div><div id=hashtags class=section><h2 style=margin-bottom:16px>–ü–æ–ø—É–ª—è—Ä–Ω—ñ —Ö–µ—à—Ç–µ–≥–∏</h2><div class=hashtag-list id=hashtagList></div></div><div id=profile class=section><div class=profile-header id=profileH></div><div class=profile-tabs id=profileTabs><div class="profile-tab active" data-tab=posts>–ü–æ—Å—Ç–∏</div><div class=profile-tab data-tab=likes>–õ–∞–π–∫–∏</div><div class=profile-tab data-tab=media>–ú–µ–¥—ñ–∞</div><div class=profile-tab data-tab=saved>–ó–±–µ—Ä–µ–∂–µ–Ω–µ</div></div><div class=feed id=profileFeed></div></div><div id=chats class=section><div style=padding:0 0 12px><input type=text id=chatSearch class=input placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤..."><div id=chatSearchRes class=user-list style="margin-top:12px;display:none"></div></div><div class=chat-list id=chatList></div><div class=chat-window id=chatWin style=display:none><div class=chat-header><div class="avatar small" id=chatAv></div><div style=flex:1><div style="display:flex;align-items:center;gap:6px"><span id=chatName style=font-size:1.2rem;font-weight:600></span><span class=online-indicator id=onlineInd style=display:none></span></div><div id=chatUserId style=color:var(--text3);font-size:.9rem></div><div id=lastSeen style=font-size:.85rem></div></div></div><div class=chat-messages id=chatMsg></div><div class=typing-indicator id=typing style=display:none><span class=dot></span><span class=dot></span><span class=dot></span><span>–¥—Ä—É–∫—É—î...</span></div><div class=chat-input-area><input type=file id=chatFile style=display:none multiple><button class=attach-btn id=attach>üìé</button><input type=text id=chatIn class=input placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."><div class=emoji-picker-container><button class=emoji-button id=chatEmoji>üòä</button><div class=emoji-picker id=chatEmojiP style=display:none></div></div><button class="btn btn-primary btn-icon" id=send><svg width=22 height=22 viewBox="0 0 24 24" fill=none stroke=currentColor><line x1=22 y1=2 x2=11 y2=13/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button></div></div></div><div id=settings class="section card"><h2 style=margin-bottom:16px>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2><div class=language-selector><span>–ú–æ–≤–∞:</span><select id=lang><option value=uk>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option><option value=ru>–†—É—Å—Å–∫–∏–π</option><option value=en>English</option></select></div><button class=btn id=toggleTheme style="margin:16px 0;width:100%"><svg width=22 height=22 viewBox="0 0 24 24" fill=none stroke=currentColor><circle cx=12 cy=12 r=5/><line x1=12 y1=1 x2=12 y2=3/><line x1=12 y1=21 x2=12 y2=23/></svg><span>–¢–µ–º–∞</span></button><button class=btn id=toggleTv style="margin:16px 0;width:100%"><svg width=22 height=22 viewBox="0 0 24 24" fill=none stroke=currentColor><rect x=2 y=7 width=20 height=15 rx=2 ry=2/><polyline points="16 21 12 15 8 21"/></svg><span>TV —Ä–µ–∂–∏–º</span></button><button class=btn id=privacyBtn style="margin:16px 0;width:100%"><svg width=22 height=22 viewBox="0 0 24 24" fill=none stroke=currentColor><rect x=3 y=11 width=18 height=11 rx=2 ry=2/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><span>–ü–æ–ª—ñ—Ç–∏–∫–∞ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—Å—Ç—ñ</span></button><button class=btn id=logout style="margin-top:16px;width:100%">–í–∏–π—Ç–∏</button></div><div id=saved class=section><h2 style=margin-bottom:16px>–ó–±–µ—Ä–µ–∂–µ–Ω–µ</h2><div class=feed id=savedFeed></div></div></div></main></div><div class=tv-remote><span><span class=key>‚ñ≤‚ñº‚óÄ‚ñ∂</span> –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è</span><span><span class=key>‚èé</span> –≤–∏–±—Ä–∞—Ç–∏</span><span><span class=key>‚éã</span> –∑–∞–∫—Ä–∏—Ç–∏</span></div><div class=modal id=editProfile><div class=modal-content><div class=modal-header><h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h3><span class=modal-close id=closeEditProfile>&times;</span></div><input type=text id=editNick class=input placeholder=–ü—Å–µ–≤–¥–æ–Ω—ñ–º><textarea id=editBio class=input placeholder="–ü—Ä–æ —Å–µ–±–µ" rows=3 style="margin:12px 0"></textarea><div class=file-input-wrapper style=margin:12px><input type=file id=editAv accept=image/*><div class=file-input-button><svg width=22 height=22 viewBox="0 0 24 24" fill=none stroke=currentColor><rect x=2 y=2 width=20 height=20 rx=2.18/><circle cx=7.5 cy=7.5 r=1.5/><polyline points="21 15 16 10 5 21"/></svg><span id=editAvLabel>–û–±—Ä–∞—Ç–∏ –∞–≤–∞—Ç–∞—Ä</span></div></div><img id=editAvPrev class=file-preview><button class="btn btn-primary" id=saveProfile>–ó–±–µ—Ä–µ–≥—Ç–∏</button></div></div><div class=modal id=editPostModal><div class=modal-content><div class=modal-header><h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å—Ç</h3><span class=modal-close id=closeEditPost>&times;</span></div><textarea id=editPostText class=input placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç—É" rows=3></textarea><div class=file-input-wrapper style=margin:12px><input type=file id=editPostMedia accept=image/*,video/*><div class=file-input-button><svg width=22 height=22 viewBox="0 0 24 24" fill=none stroke=currentColor><rect x=2 y=2 width=20 height=20 rx=2.18/><circle cx=7.5 cy=7.5 r=1.5/><polyline points="21 15 16 10 5 21"/></svg><span id=editPostLabel>–ó–º—ñ–Ω–∏—Ç–∏ –º–µ–¥—ñ–∞</span></div></div><img id=editPostPrev class=file-preview><button class="btn btn-primary" id=savePostEdit>–ó–±–µ—Ä–µ–≥—Ç–∏</button><button class="btn btn-danger" id=deletePostBtn style=margin-top:12px>–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç</button></div></div><div class=modal id=followersModal><div class=modal-content><div class=modal-header><h3>–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏</h3><span class=modal-close id=closeFollowers>&times;</span></div><div id=followersList style="max-height:400px;overflow-y:auto"></div></div></div><div class=modal id=followingModal><div class=modal-content><div class=modal-header><h3>–ü—ñ–¥–ø–∏—Å–∫–∏</h3><span class=modal-close id=closeFollowing>&times;</span></div><div id=followingList style="max-height:400px;overflow-y:auto"></div></div></div><div class=modal id=privacyModal><div class=modal-content><div class=modal-header><h3>–ü–æ–ª—ñ—Ç–∏–∫–∞ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—Å—Ç—ñ</h3><span class=modal-close id=closePrivacy>&times;</span></div><div style=max-height:60vh;overflow-y:auto><p>FANTASYAS –ø–æ–≤–∞–∂–∞—î –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ—Å—Ç—å. –ú–∏ –∑–±–∏—Ä–∞—î–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ.</p></div></div></div><div id=toast></div><script type=module>import{initializeApp}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut,GoogleAuthProvider,OAuthProvider,signInWithPopup,sendPasswordResetEmail}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";import{getFirestore,doc,setDoc,getDoc,updateDoc,collection,addDoc,query,where,onSnapshot,orderBy,serverTimestamp,arrayUnion,arrayRemove,deleteDoc,getDocs,increment,limit,startAfter,writeBatch}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";import{getStorage,ref,uploadBytes,getDownloadURL,deleteObject}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";const firebaseConfig={apiKey:"AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",authDomain:"fantasyasapp.firebaseapp.com",projectId:"fantasyasapp",storageBucket:"fantasyasapp.appspot.com",messagingSenderId:"721763921060",appId:"1:721763921060:web:3d61044ea2424e8176ca31"};const app=initializeApp(firebaseConfig);const auth=getAuth(app);const db=getFirestore(app);const storage=getStorage(app);let u=null,cp=null,cid=null,cu=null,ep=null,uf=null,uc=null,ucl=null,uty=null,uos=null,li=null,unread=0,feedT='new',lastV=null,loading=!1,hasMore=!0,viewed=new Set,comUnsub=new Map;const esc=t=>t.replace(/[&<>"]/g,m=>m=='&'?'&amp;':m=='<'?'&lt;':m=='>'?'&gt;':m=='"'?'&quot;':m),showToast=t=>{const e=document.getElementById('toast');e.textContent=t,e.classList.add('show'),setTimeout(()=>e.classList.remove('show'),3e3)},vibrate=t=>{navigator.vibrate&&navigator.vibrate(t)},updateBadge=()=>{const e=document.getElementById('unread');e&&(unread>0?(e.textContent=unread>99?'99+':unread,e.style.display='inline-block'):e.style.display='none')},cleanup=()=>{uf&&(uf(),uf=null);uc&&(uc(),uc=null);ucl&&(ucl(),ucl=null);uty&&(uty(),uty=null);uos&&(uos(),uos=null);li&&clearInterval(li);comUnsub.forEach(u=>u());comUnsub.clear()},reportUser=async(t,r='')=>{if(!u)return;if(!confirm('–ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—è?'))return;try{await addDoc(collection(db,'reports'),{reportedUserId:t,reporterId:u.uid,reason:r||'–ë–µ–∑ –ø—Ä–∏—á–∏–Ω–∏',timestamp:serverTimestamp()});showToast('–°–∫–∞—Ä–≥—É –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ')}catch(e){showToast(e.message)}},blockUser=async t=>{if(!u||!confirm('–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏?'))return;try{await updateDoc(doc(db,'users',u.uid),{blockedUsers:arrayUnion(t)});showToast('–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ')}catch(e){showToast(e.message)}};const sect=['home','search','hashtags','profile','chats','settings','saved'];document.querySelectorAll('.nav-item').forEach(i=>{i.addEventListener('click',()=>{let s=i.dataset.sec;if(!s)return;document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));i.classList.add('active');sect.forEach(s=>document.getElementById(s)?.classList.remove('active'));document.getElementById(s).classList.add('active');document.getElementById('pt').textContent=i.querySelector('span').textContent;cleanup();if(s=='home'&&u)resetP();if(s=='search'&&u)loadSearch();if(s=='hashtags'&&u)loadTags();if(s=='chats'&&u){document.getElementById('chatWin').style.display='none';loadChats();document.getElementById('chatSearchRes').style.display='none';document.getElementById('chatSearch').value=''}if(s=='profile'&&u)viewProfile(u.uid);if(s=='saved'&&u)loadSaved();closeS()})});const sd=document.getElementById('sd'),menu=document.getElementById('menu'),bd=document.getElementById('sdB');function openS(){sd.classList.add('open');menu.classList.add('active');bd.classList.add('active')}function closeS(){sd.classList.remove('open');menu.classList.remove('active');bd.classList.remove('active')}menu.addEventListener('click',e=>{e.stopPropagation();sd.classList.contains('open')?closeS():openS()});bd.addEventListener('click',closeS);function buildEmoji(picker,input){if(!picker||!input)return;picker.innerHTML='';picker.classList.add('emoji-picker');const search=document.createElement('input');search.type='text';search.placeholder='üîç –ü–æ—à—É–∫...';search.classList.add('emoji-search');picker.appendChild(search);const cats=document.createElement('div');cats.classList.add('emoji-categories');['smileys','animals','food','travel','objects','symbols'].forEach(c=>{const b=document.createElement('span');b.classList.add('emoji-category');b.textContent=c=='smileys'?'üòä':c=='animals'?'üê∂':c=='food'?'üçî':c=='travel'?'‚úàÔ∏è':c=='objects'?'üì±':'üî£';b.dataset.cat=c;b.onclick=()=>{document.querySelectorAll('.emoji-category').forEach(c=>c.classList.remove('active'));b.classList.add('active');filter(c,'')};cats.appendChild(b)});picker.appendChild(cats);const grid=document.createElement('div');grid.classList.add('emoji-grid');picker.appendChild(grid);let curCat='smileys',curSearch='';function render(cat,search){let em=emoji[cat]||[];if(search)em=em.filter(e=>e.includes(search));grid.innerHTML='';em.forEach(e=>{const s=document.createElement('span');s.textContent=e;s.onclick=()=>{const st=input.selectionStart;const en=input.selectionEnd;input.value=input.value.substring(0,st)+e+input.value.substring(en);input.focus();input.selectionStart=input.selectionEnd=st+e.length;picker.style.display='none'};s.tabIndex=0;grid.appendChild(s)})}function filter(cat,search){curCat=cat;curSearch=search;render(cat,search)}search.addEventListener('input',e=>filter(curCat,e.target.value));const fc=cats.querySelector('.emoji-category');fc&&(fc.classList.add('active'),render('smileys',''))}const emoji={smileys:['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü•∏','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üòà','üëø','üëπ','üë∫','ü§°','üí©','üëª','üíÄ','‚ò†Ô∏è','üëΩ','üëæ','ü§ñ','üéÉ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'],animals:['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêô','ü¶ë','ü¶ê','ü¶û','üê†','üêü','üê°','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','üêò','ü¶õ','ü¶è','üê™','üê´','ü¶í','ü¶ò','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêè','üêë','ü¶ô','üêê','ü¶å','üêï','üê©','üêà','üêì','ü¶É','ü¶ö','ü¶ú','ü¶¢','ü¶©','üïäÔ∏è','üêá','ü¶ù','ü¶®','ü¶°','ü¶¶','ü¶•','üêÅ','üêÄ','üêøÔ∏è','ü¶î','üêæ'],food:['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üå∂Ô∏è','ü´ë','üåΩ','ü•ï','ü´í','üßÑ','üßÖ','ü•î','üç†','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üç≥','üßà','ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','üçî','üçü','üçï','ü´ì','ü•™','ü•ô','üßÜ','üåÆ','üåØ','ü´î','ü•ó','ü•ò','ü´ï','ü•´','üçù','üçú','üç≤','üçõ','üç£','üç±','ü•ü','ü¶™','üç§','üçô','üçö','üçò','üç•','ü•†','ü•Æ','üç¢','üç°','üçß','üç®','üç¶','ü•ß','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üçø','üç©','üç™','üå∞','ü•ú','üçØ','ü•õ','üçº','‚òï','ü´ñ','üçµ','üßÉ','ü•§','üßã','üç∂','üç∫','üçª','ü•Ç','üç∑','ü•É','üç∏','üçπ','üßâ','üçæ','üßä','ü•Ñ','üç¥','ü•£']};function setupEmoji(bId,pId,iId){const b=document.getElementById(bId),p=document.getElementById(pId),i=document.getElementById(iId);if(!b||!p||!i)return;p.hasChildNodes()||buildEmoji(p,i);b.addEventListener('click',e=>{e.stopPropagation();document.querySelectorAll('.emoji-picker').forEach(p=>p.style.display='none');p.style.display=p.style.display==='none'?'flex':'none'});document.addEventListener('click',e=>{!p.contains(e.target)&&e.target!==b&&(p.style.display='none')})}function setupFile(iId,lId,pId){const i=document.getElementById(iId),l=document.getElementById(lId),p=document.getElementById(pId);i&&l&&i.addEventListener('change',function(){if(this.files&&this.files[0]){const f=this.files[0];l.textContent=f.name.length>30?f.name.substring(0,30)+'‚Ä¶':f.name;if(p&&f.type.startsWith('image/')){const r=new FileReader;r.onload=e=>{p.src=e.target.result;p.classList.add('show')};r.readAsDataURL(f)}else p?.classList.remove('show')}else{l.textContent=iId.includes('Av')?'–û–±—Ä–∞—Ç–∏ –∞–≤–∞—Ç–∞—Ä':'–û–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ';p?.classList.remove('show')}})}function extractTags(t){return(t.match(/#(\w+)/g)||[]).map(t=>t.toLowerCase())}async function loadTags(){const l=document.getElementById('hashtagList');if(!l)return;l.innerHTML='<div class="skeleton" style="height:50px"></div>';try{const s=await getDocs(collection(db,'posts'));const m=new Map;s.forEach(d=>{(d.data().hashtags||[]).forEach(t=>m.set(t,(m.get(t)||0)+1))});const a=Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0,20);l.innerHTML='';if(!a.length){l.innerHTML='<p style="text-align:center;padding:16px">–ü–æ–∫–∏ –Ω–µ–º–∞—î —Ö–µ—à—Ç–µ–≥—ñ–≤</p>';return}a.forEach(([t,c])=>{const d=document.createElement('div');d.className='hashtag-item';d.innerHTML=`<span class="hashtag-name">${t}</span><span class="hashtag-count">${c} –ø–æ—Å—Ç—ñ–≤</span>`;d.onclick=()=>searchTag(t);d.tabIndex=0;l.appendChild(d)})}catch(e){l.innerHTML='<p>–ü–æ–º–∏–ª–∫–∞</p>'}}function searchTag(t){const inp=document.getElementById('searchIn');inp&&(inp.value='#'+t,document.querySelector('[data-sec="search"]').click(),loadSearch())}document.getElementById('toReg').onclick=()=>{document.getElementById('login').style.display='none';document.getElementById('reg').style.display='block'};document.getElementById('toLog').onclick=()=>{document.getElementById('reg').style.display='none';document.getElementById('login').style.display='block'};document.getElementById('regBtn').onclick=async()=>{const n=document.getElementById('regNick').value.trim(),p=document.getElementById('regPass').value.trim();if(!n)return alert('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');if(p.length<6)return alert('–ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤');const uid='@'+n.toLowerCase();const q=query(collection(db,'users'),where('userId','==',uid));const s=await getDocs(q);if(!s.empty)return alert('ID –∑–∞–π–Ω—è—Ç–∏–π');try{const e=n.toLowerCase().replace(/[^a-z0-9]/g,'')+'_'+Math.floor(Math.random()*1e4)+'@fantasyas.local';const c=await createUserWithEmailAndPassword(auth,e,p);await setDoc(doc(db,'users',c.user.uid),{nickname:n,userId:uid,nickname_lower:n.toLowerCase(),bio:'',avatar:'',posts:[],likedPosts:[],savedPosts:[],followers:[],following:[],mutedUsers:[],blockedUsers:[],createdAt:serverTimestamp(),lastOnline:serverTimestamp(),email:e});showToast('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞');document.getElementById('toLog').click()}catch(e){showToast(e.message)}};document.getElementById('loginBtn').onclick=async()=>{const n=document.getElementById('loginNick').value.trim(),p=document.getElementById('loginPass').value.trim();if(!n||!p)return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');try{const uid='@'+n.toLowerCase();const q=query(collection(db,'users'),where('userId','==',uid));const s=await getDocs(q);if(s.empty)return alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');const d=s.docs[0].data(),e=d.email;if(!e)return alert('Email –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, —É–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Google/Apple');await signInWithEmailAndPassword(auth,e,p)}catch{alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ –ø–∞—Ä–æ–ª—å')}};document.getElementById('googleBtn').onclick=async()=>{const p=new GoogleAuthProvider;try{const r=await signInWithPopup(auth,p),u=r.user;if(!(await getDoc(doc(db,'users',u.uid))).exists()){let nick=u.displayName||u.email?.split('@')[0]||'user',uid='@'+nick.toLowerCase();const q=query(collection(db,'users'),where('userId','==',uid)),s=await getDocs(q);s.empty||(uid='@'+nick.toLowerCase()+Math.floor(Math.random()*1e3));await setDoc(doc(db,'users',u.uid),{nickname:nick,userId:uid,nickname_lower:nick.toLowerCase(),bio:'',avatar:u.photoURL||'',posts:[],likedPosts:[],savedPosts:[],followers:[],following:[],mutedUsers:[],blockedUsers:[],createdAt:serverTimestamp(),lastOnline:serverTimestamp(),email:u.email})}showToast('–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π')}catch(e){showToast(e.message)}};document.getElementById('forgotPass').onclick=async e=>{e.preventDefault();const n=prompt('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');if(!n)return;const uid='@'+n.toLowerCase(),q=query(collection(db,'users'),where('userId','==',uid)),s=await getDocs(q);if(s.empty)return alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');const em=s.docs[0].data().email;if(!em)return alert('Email –≤—ñ–¥—Å—É—Ç–Ω—ñ–π');try{await sendPasswordResetEmail(auth,em);showToast('–õ–∏—Å—Ç –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ')}catch(err){showToast(err.message)}};onAuthStateChanged(auth,user=>{cleanup();if(user){u=user;cu=user.uid;document.getElementById('auth').style.display='none';document.getElementById('newPost').style.display='block';li=setInterval(()=>{updateDoc(doc(db,'users',u.uid),{lastOnline:serverTimestamp()}).catch(()=>{})},3e4);resetP();loadMyProfile();const q=query(collection(db,'chats'),where('participants','array-contains',u.uid));ucl=onSnapshot(q,s=>{let t=0;s.forEach(d=>{t+=d.data().unread?.[u.uid]||0});unread=t;updateBadge();document.getElementById('chats')?.classList.contains('active')&&loadChats()},()=>showToast('–ü–æ–º–∏–ª–∫–∞ —á–∞—Ç—ñ–≤'));setupEmoji('postEmoji','postEmojiP','postText');setupEmoji('chatEmoji','chatEmojiP','chatIn');setupFile('postMedia','postMediaLabel','postMediaPrev');setupFile('editAv','editAvLabel','editAvPrev');setupFile('editPostMedia','editPostLabel','editPostPrev')}else{u=null;document.getElementById('auth').style.display='block';document.getElementById('newPost').style.display='none';unread=0;updateBadge()}});document.getElementById('feedNew').onclick=()=>{feedT='new';resetP()};document.getElementById('feedPop').onclick=()=>{feedT='popular';resetP()};function resetP(){lastV=null;hasMore=!0;document.getElementById('feed').innerHTML='';comUnsub.forEach(u=>u());comUnsub.clear();loadMore()}function formatContent(t){if(!t)return'<div class="hashtag-row"></div>';const r=/#(\w+)/g;let l=0,p=[],m;while((m=r.exec(t))!==null){m.index>l&&p.push(esc(t.substring(l,m.index)));p.push(`<span class="hashtag" data-tag="${esc(m[1])}">#${esc(m[1])}</span>`);l=m.index+m[0].length}l<t.length&&p.push(esc(t.substring(l)));return'<div class="hashtag-row">'+p.join('')+'</div>'}function subComments(pId,cont){if(!cont)return;const q=query(collection(db,`posts/${pId}/comments`),orderBy('createdAt'));const un=onSnapshot(q,s=>loadComments(pId,cont,s),()=>showToast('–ü–æ–º–∏–ª–∫–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤'));comUnsub.set(pId,un)}async function loadComments(pId,cont,snap){cont.innerHTML='';if(snap.empty){cont.innerHTML='<p style="text-align:center;padding:8px">–ù–µ–º–∞—î –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤</p>';return}for(const d of snap.docs){const c=d.data(),id=d.id,rs=await getDocs(query(collection(db,`posts/${pId}/comments/${id}/replies`),orderBy('createdAt'))),re=[];rs.forEach(r=>re.push({id:r.id,...r.data()}));const liked=c.likes?.includes(u?.uid)||false,t=c.createdAt?new Date(c.createdAt.seconds*1e3).toLocaleString():'';const el=document.createElement('div');el.className='comment';el.dataset.commentId=id;el.innerHTML=`<div class="comment-main"><div class="comment-avatar" style="background-image:url(${c.authorAvatar||''})" data-uid="${c.author}"></div><div class="comment-content"><div><span class="comment-author" data-uid="${c.author}">${esc(c.authorName)}</span> <span class="comment-time">${t}</span></div><div class="comment-text">${esc(c.text)}</div></div></div><div class="comment-actions"><button class="like-comment-btn ${liked?'liked':''}" data-post="${pId}" data-comment="${id}"><svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=currentColor><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span>${c.likesCount||0}</span></button><button class="reply-btn" data-post="${pId}" data-comment="${id}">–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button></div><div class="replies" id="replies-${pId}-${id}">${re.map(r=>`<div class="reply"><div class="comment-avatar" style="background-image:url(${r.authorAvatar||''})" data-uid="${r.author}"></div><div class="comment-content"><div><span class="comment-author" data-uid="${r.author}">${esc(r.authorName)}</span> <span class="comment-time">${new Date(r.createdAt?.seconds*1e3).toLocaleString()}</span></div><div class="comment-text">${esc(r.text)}</div></div></div>`).join('')}</div><div class="reply-form" id="reply-form-${pId}-${id}" style="display:none"><input type="text" class="reply-input" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." id="reply-input-${pId}-${id}"><button class="btn btn-primary btn-icon send-reply" data-post="${pId}" data-comment="${id}"><svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=currentColor><line x1=22 y1=2 x2=11 y2=13/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button></div>`;cont.appendChild(el)}cont.querySelectorAll('.reply-btn').forEach(btn=>{btn.addEventListener('click',()=>{const cid=btn.dataset.comment;document.getElementById(`reply-form-${pId}-${cid}`).style.display='flex'})});cont.querySelectorAll('.send-reply').forEach(btn=>{btn.addEventListener('click',async()=>{const cid=btn.dataset.comment,inp=document.getElementById(`reply-input-${pId}-${cid}`),txt=inp.value.trim();if(!txt)return;try{const us=await getDoc(doc(db,'users',u.uid)),user=us.data();await addDoc(collection(db,`posts/${pId}/comments/${cid}/replies`),{author:u.uid,authorName:user.nickname,authorAvatar:user.avatar||'',text:txt,createdAt:serverTimestamp()});inp.value='';document.getElementById(`reply-form-${pId}-${cid}`).style.display='none'}catch{showToast('–ü–æ–º–∏–ª–∫–∞')}})});cont.querySelectorAll('.like-comment-btn').forEach(btn=>{btn.addEventListener('click',async()=>{const cid=btn.dataset.comment,liked=btn.classList.contains('liked'),cnt=btn.querySelector('span'),old=parseInt(cnt.textContent);btn.classList.toggle('liked');cnt.textContent=liked?old-1:old+1;try{const r=doc(db,`posts/${pId}/comments`,cid);liked?await updateDoc(r,{likes:arrayRemove(u.uid),likesCount:increment(-1)}):await updateDoc(r,{likes:arrayUnion(u.uid),likesCount:increment(1)})}catch{btn.classList.toggle('liked');cnt.textContent=old}}})}async function addComment(pId,txt){if(!u||!txt.trim())return;const us=await getDoc(doc(db,'users',u.uid)),user=us.data();await addDoc(collection(db,`posts/${pId}/comments`),{author:u.uid,authorName:user.nickname,authorAvatar:user.avatar||'',text:txt.trim(),createdAt:serverTimestamp(),likes:[],likesCount:0});await updateDoc(doc(db,'posts',pId),{commentsCount:increment(1)})}async function incView(pId){if(!u||viewed.has(pId))return;viewed.add(pId);try{await updateDoc(doc(db,'posts',pId),{views:increment(1)})}catch{}}function renderPosts(docs,cont){const f=cont||document.getElementById('feed');docs.forEach(d=>{const p={id:d.id,...d.data()},liked=p.likes?.includes(u?.uid)||false,saved=p.saves?.includes(u?.uid)||false,pt=p.createdAt?new Date(p.createdAt.seconds*1e3).toLocaleString():'',isAuth=u&&p.author===u.uid,el=document.createElement('div');el.className='post';el.dataset.postId=p.id;el.tabIndex=0;let act='';isAuth&&(act='<div class="post-actions"><button class="edit-post-btn">‚ãØ</button></div>');el.innerHTML=`${act}<div class="post-header"><div class="avatar small" style="background-image:url(${p.authorAvatar||''})" data-uid="${p.author}"></div><div class="post-author-info"><div><span class="post-author" data-uid="${p.author}">${esc(p.authorName||'–ù–µ–≤—ñ–¥–æ–º–æ')}</span> <span class="post-meta">${esc(p.authorUserId||'')}</span></div><div class="post-time">${pt}</div></div></div><div class="post-content">${formatContent(p.text)}</div>${p.mediaUrl?p.mediaType==='image'?`<img src="${p.mediaUrl}" class="post-media" loading="lazy">`:`<video src="${p.mediaUrl}" controls class="post-media"></video>`:''}<div class="post-footer"><button class="like-btn ${liked?'liked':''}" data-post-id="${p.id}"><svg viewBox="0 0 24 24" width=20 height=20><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span>${p.likesCount||0}</span></button><button class="comment-toggle-btn" data-post-id="${p.id}"><svg viewBox="0 0 24 24" width=20 height=20><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>${p.commentsCount||0}</span></button><button class="save-btn ${saved?'saved':''}" data-post-id="${p.id}"><svg viewBox="0 0 24 24" width=20 height=20><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg></button><span class="view-count"><svg width=18 height=18 viewBox="0 0 24 24" fill=none stroke=currentColor><circle cx=12 cy=12 r=2/><path d="M22 12c-2.667 4.667-6 7-10 7s-7.333-2.333-10-7c2.667-4.667 6-7 10-7s7.333 2.333 10 7z"/></svg>${p.views||0}</span></div><div class="comments-section collapsed" id="comments-${p.id}"><div class="comments-list" id="comments-list-${p.id}"></div><div class="comment-form" style="display:flex;gap:8px"><input type="text" id="comment-input-${p.id}" class="comment-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä..." style="flex:1"><button class="btn btn-primary btn-icon" id="submit-comment-${p.id}"><svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=currentColor><line x1=22 y1=2 x2=11 y2=13/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button></div></div>`;f.appendChild(el);incView(p.id);if(isAuth)el.querySelector('.edit-post-btn').onclick=()=>openEditPost(p);el.querySelectorAll('.hashtag').forEach(s=>{s.onclick=e=>{e.stopPropagation();searchTag(s.dataset.tag)}});el.querySelector('.comment-toggle-btn').addEventListener('click',e=>{e.stopPropagation();el.querySelector('.comments-section').classList.toggle('collapsed')});const cl=document.getElementById(`comments-list-${p.id}`);cl&&subComments(p.id,cl);document.getElementById(`submit-comment-${p.id}`).onclick=async()=>{const txt=document.getElementById(`comment-input-${p.id}`).value.trim();if(!txt)return;await addComment(p.id,txt);document.getElementById(`comment-input-${p.id}`).value='';const cnt=el.querySelector('.comment-toggle-btn span');cnt.textContent=parseInt(cnt.textContent)+1}})}document.getElementById('addPost').onclick=async()=>{if(!u)return alert('–£–≤—ñ–π–¥—ñ—Ç—å');const txt=document.getElementById('postText').value.trim(),file=document.getElementById('postMedia').files[0];if(!txt&&!file)return alert('–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞');try{let url='',type='';if(file){const sref=ref(storage,`posts/${u.uid}/${Date.now()}_${file.name}`);await uploadBytes(sref,file);url=await getDownloadURL(sref);type=file.type.split('/')[0]}const us=await getDoc(doc(db,'users',u.uid)),user=us.data(),tags=extractTags(txt),p=await addDoc(collection(db,'posts'),{author:u.uid,authorName:user.nickname,authorUserId:user.userId,authorAvatar:user.avatar||'',text:txt,mediaUrl:url,mediaType:type,createdAt:serverTimestamp(),likes:[],likesCount:0,commentsCount:0,saves:[],views:0,hashtags:tags});await updateDoc(doc(db,'users',u.uid),{posts:arrayUnion(p.id)});const np={id:p.id,author:u.uid,authorName:user.nickname,authorUserId:user.userId,authorAvatar:user.avatar||'',text:txt,mediaUrl:url,mediaType:type,createdAt:{seconds:Date.now()/1e3},likes:[],likesCount:0,commentsCount:0,saves:[],views:0,hashtags:tags};renderPosts([{id:p.id,data:()=>np}],document.getElementById('feed'));document.getElementById('postText').value='';document.getElementById('postMedia').value='';document.getElementById('postMediaLabel').textContent='–û–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ';document.getElementById('postMediaPrev').classList.remove('show');showToast('–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!')}catch(e){showToast(e.message)}};async function loadMore(){if(!u||loading||!hasMore)return;loading=!0;document.getElementById('skeleton').style.display='block';try{let q;if(feedT==='new')q=query(collection(db,'posts'),orderBy('createdAt','desc'),limit(10));else q=query(collection(db,'posts'),orderBy('likesCount','desc'),orderBy('createdAt','desc'),limit(10));lastV&&(q=query(q,startAfter(lastV)));const s=await getDocs(q);if(s.empty){hasMore=!1;return}lastV=s.docs[s.docs.length-1];renderPosts(s.docs)}catch(e){console.error(e);showToast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω–¥–µ–∫—Å–∏ Firestore.')}finally{document.getElementById('skeleton').style.display='none';loading=!1}}const sentinel=document.getElementById('feedSentinel');sentinel&&new IntersectionObserver(e=>{e[0].isIntersecting&&loadMore()},{threshold:.5}).observe(sentinel);function openEditPost(p){ep=p;document.getElementById('editPostText').value=p.text||'';document.getElementById('editPostMedia').value='';document.getElementById('editPostLabel').textContent='–ó–º—ñ–Ω–∏—Ç–∏ –º–µ–¥—ñ–∞';const prev=document.getElementById('editPostPrev');prev.classList.remove('show');p.mediaUrl&&p.mediaType==='image'&&(prev.src=p.mediaUrl,prev.classList.add('show'));document.getElementById('editPostModal').classList.add('active')}document.getElementById('closeEditPost').onclick=()=>{document.getElementById('editPostModal').classList.remove('active');ep=null};document.getElementById('savePostEdit').onclick=async()=>{if(!ep||!u)return;const txt=document.getElementById('editPostText').value.trim(),file=document.getElementById('editPostMedia').files[0];try{const ref=doc(db,'posts',ep.id),up={text:txt};up.hashtags=extractTags(txt);if(file){ep.mediaUrl&&await deleteObject(ref(storage,ep.mediaUrl)).catch(()=>{});const sref=ref(storage,`posts/${u.uid}/${Date.now()}_${file.name}`);await uploadBytes(sref,file);up.mediaUrl=await getDownloadURL(sref);up.mediaType=file.type.split('/')[0]}await updateDoc(ref,up);showToast('–û–Ω–æ–≤–ª–µ–Ω–æ');document.getElementById('editPostModal').classList.remove('active')}catch(e){showToast(e.message)}};document.getElementById('deletePostBtn').onclick=async()=>{if(!ep||!u||!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç?'))return;try{ep.mediaUrl&&await deleteObject(ref(storage,ep.mediaUrl)).catch(()=>{});await deleteDoc(doc(db,'posts',ep.id));await updateDoc(doc(db,'users',u.uid),{posts:arrayRemove(ep.id)});showToast('–í–∏–¥–∞–ª–µ–Ω–æ');document.getElementById('editPostModal').classList.remove('active')}catch(e){showToast(e.message)}};async function loadSearch(){if(!u)return;const val=document.getElementById('searchIn').value.trim().toLowerCase(),ul=document.getElementById('userList');if(!val){ul.innerHTML='';return}if(val.startsWith('#')){const tag=val.substring(1),q=query(collection(db,'posts'),where('hashtags','array-contains',tag)),s=await getDocs(q);ul.innerHTML='<h3 style="margin-bottom:12px">–ü–æ—Å—Ç–∏ –∑ —Ç–µ–≥–æ–º</h3>';if(s.empty)ul.innerHTML+='<p>–ù–µ–º–∞—î –ø–æ—Å—Ç—ñ–≤</p>';else{const f=document.createElement('div');f.className='feed';ul.appendChild(f);renderPosts(s.docs,f)}return}const me=await getDoc(doc(db,'users',u.uid)),myF=me.data().following||[],q1=query(collection(db,'users'),where('userId','>=',val.startsWith('@')?val:'@'+val),where('userId','<=',(val.startsWith('@')?val:'@'+val)+'\uf8ff')),q2=query(collection(db,'users'),where('nickname_lower','>=',val),where('nickname_lower','<=',val+'\uf8ff')),[s1,s2]=await Promise.all([getDocs(q1),getDocs(q2)]),m=new Map;s1.forEach(d=>m.set(d.id,d.data()));s2.forEach(d=>m.set(d.id,d.data()));ul.innerHTML='';m.forEach((data,uid)=>{if(uid===u.uid)return;const fol=myF.includes(uid),div=document.createElement('div');div.className='chat-item';div.innerHTML=`<div class="avatar small" style="background-image:url(${data.avatar||''})" data-uid="${uid}"></div><div class="chat-info"><div class="chat-name">${data.nickname}</div><div class="chat-last">${data.userId}</div></div><button class="btn follow-btn">${fol?'–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è':'–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>`;div.querySelector('.follow-btn').onclick=async e=>{e.stopPropagation();const was=fol;div.querySelector('.follow-btn').textContent=was?'–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è':'–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';try{await toggleFollow(uid)}catch{div.querySelector('.follow-btn').textContent=was?'–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è':'–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}};div.onclick=()=>viewProfile(uid);ul.appendChild(div)})}document.getElementById('searchIn').addEventListener('input',loadSearch);async function toggleFollow(t){if(!u)return;const my=doc(db,'users',u.uid),their=doc(db,'users',t),myS=await getDoc(my);if(myS.data().following.includes(t)){await updateDoc(my,{following:arrayRemove(t)});await updateDoc(their,{followers:arrayRemove(u.uid)})}else{await updateDoc(my,{following:arrayUnion(t)});await updateDoc(their,{followers:arrayUnion(u.uid)})}}async function loadMyProfile(){if(!u)return;const s=await getDoc(doc(db,'users',u.uid));s.exists()&&renderProfile(s.data(),u.uid,!0)}function viewProfile(uid){cu=uid;document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.querySelector('[data-sec="profile"]').classList.add('active');sect.forEach(s=>document.getElementById(s).classList.remove('active'));document.getElementById('profile').classList.add('active');document.getElementById('pt').textContent='–ü—Ä–æ—Ñ—ñ–ª—å';uid===u?.uid?loadMyProfile():loadUserProfile(uid);closeS()}async function loadUserProfile(uid){if(!u)return;const s=await getDoc(doc(db,'users',uid));s.exists()&&renderProfile(s.data(),uid,uid===u.uid)}function renderProfile(d,uid,own){const h=document.getElementById('profileH');if(!h)return;if(!own&&u&&d.blockedUsers?.includes(u.uid)){h.innerHTML=`<div class="avatar large" style="background-image:url(${d.avatar||''})" data-uid="${uid}"></div><div><h2>${d.nickname}</h2><p class="text-danger">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∞—Å –∑–∞–±–ª–æ–∫—É–≤–∞–≤</p></div>`;return}const fol=!own&&u?d.followers?.includes(u.uid)||false:false;h.innerHTML=`<div class="avatar large" style="background-image:url(${d.avatar||''})" data-uid="${uid}"></div><div style="flex:1"><h2>${d.nickname}</h2><div class="user-id">${d.userId}</div><p>${d.bio||''}</p><div class="profile-stats"><span id="follCnt" data-uid="${uid}">${d.followers?.length||0} –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</span><span id="folgCnt" data-uid="${uid}">${d.following?.length||0} –ø—ñ–¥–ø–∏—Å–æ–∫</span><span>${d.posts?.length||0} –ø–æ—Å—Ç—ñ–≤</span></div>${!own&&u?`<div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="pfFollow">${fol?'–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è':'–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button><button class="btn" id="pfMsg">–ù–∞–ø–∏—Å–∞—Ç–∏</button></div>`:''}${own?'<button class="btn" id="editProf">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>':''}</div>${!own&&u?`<div class="profile-menu"><button class="profile-menu-btn" id="profMenu">‚ãØ</button><div class="profile-menu-dropdown" id="profDrop"><div class="profile-menu-item" id="reportUser">–ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—è</div><div class="profile-menu-item" id="blockUser">–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏</div></div></div>`:''}`;document.getElementById('follCnt')?.addEventListener('click',()=>openFollowList(uid,'f'));document.getElementById('folgCnt')?.addEventListener('click',()=>openFollowList(uid,'g'));if(!own&&u){document.getElementById('pfFollow').onclick=async e=>{e.stopPropagation();const was=fol;document.getElementById('pfFollow').textContent=was?'–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è':'–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';const sp=document.getElementById('follCnt');let cnt=parseInt(sp.textContent);sp.textContent=`${was?cnt-1:cnt+1} –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤`;try{await toggleFollow(uid)}catch{document.getElementById('pfFollow').textContent=was?'–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è':'–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';sp.textContent=`${was?cnt+1:cnt-1} –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤`}};document.getElementById('pfMsg').onclick=()=>openChat(d.nickname,uid,d.userId);const mb=document.getElementById('profMenu'),dd=document.getElementById('profDrop');mb&&(mb.onclick=e=>{e.stopPropagation();dd.classList.toggle('show')},document.addEventListener('click',e=>{mb.contains(e.target)||dd.classList.remove('show')}),document.getElementById('reportUser').onclick=()=>{dd.classList.remove('show');reportUser(uid)},document.getElementById('blockUser').onclick=()=>{dd.classList.remove('show');blockUser(uid)})}own&&document.getElementById('editProf').onclick=()=>{document.getElementById('editNick').value=d.nickname;document.getElementById('editBio').value=d.bio||'';document.getElementById('editAv').value='';document.getElementById('editAvLabel').textContent='–û–±—Ä–∞—Ç–∏ –∞–≤–∞—Ç–∞—Ä';document.getElementById('editAvPrev').classList.remove('show');document.getElementById('editProfile').classList.add('active')};document.querySelectorAll('.profile-tab').forEach(t=>{t.onclick=()=>{document.querySelectorAll('.profile-tab').forEach(t=>t.classList.remove('active'));t.classList.add('active');loadProfileFeed(uid,t.dataset.tab)}});loadProfileFeed(uid,'posts')}async function openFollowList(uid,type){const modal=document.getElementById(type==='f'?'followersModal':'followingModal'),list=document.getElementById(type==='f'?'followersList':'followingList');if(!modal||!list)return;list.innerHTML='<div class="skeleton" style="height:50px"></div>';modal.classList.add('active');const us=await getDoc(doc(db,'users',uid)),ids=type==='f'?us.data().followers||[]:us.data().following||[],users=[];for(const id of ids){const s=await getDoc(doc(db,'users',id));s.exists()&&users.push({id,...s.data()})}list.innerHTML='';if(!users.length)list.innerHTML='<p style="text-align:center;padding:16px">–ù–µ–º–∞—î</p>';else users.forEach(u=>{const d=document.createElement('div');d.className='chat-item';d.innerHTML=`<div class="avatar small" style="background-image:url(${u.avatar||''})" data-uid="${u.id}"></div><div class="chat-info"><div class="chat-name">${u.nickname}</div><div class="chat-last">${u.userId}</div></div>`;d.onclick=()=>{viewProfile(u.id);modal.classList.remove('active')};list.appendChild(d)})}document.getElementById('closeFollowers').onclick=()=>document.getElementById('followersModal').classList.remove('active');document.getElementById('closeFollowing').onclick=()=>document.getElementById('followingModal').classList.remove('active');async function loadProfileFeed(uid,tab){const f=document.getElementById('profileFeed');if(!f)return;f.innerHTML='';let posts=[];const us=await getDoc(doc(db,'users',uid)),ud=us.data();if(tab==='posts'){const ids=ud.posts||[];for(const id of ids.slice(0,20)){const s=await getDoc(doc(db,'posts',id));s.exists()&&posts.push({id,...s.data()})}}else if(tab==='likes'){const ids=ud.likedPosts||[];for(const id of ids.slice(0,20)){const s=await getDoc(doc(db,'posts',id));s.exists()&&posts.push({id,...s.data()})}}else if(tab==='media'){const q=query(collection(db,'posts'),where('author','==',uid),where('mediaUrl','!=',''));const s=await getDocs(q);s.forEach(d=>posts.push({id:d.id,...d.data()}))}else if(tab==='saved'){const ids=ud.savedPosts||[];for(const id of ids.slice(0,20)){const s=await getDoc(doc(db,'posts',id));s.exists()&&posts.push({id,...s.data()})}}posts.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));posts.length?renderPosts(posts.map(p=>({id:p.id,data:()=>p})),f):f.innerHTML='<p style="text-align:center;padding:16px">–ù–µ–º–∞—î –ø–æ—Å—Ç—ñ–≤</p>'}document.getElementById('closeEditProfile').onclick=()=>document.getElementById('editProfile').classList.remove('active');document.getElementById('saveProfile').onclick=async()=>{if(!u)return;const nick=document.getElementById('editNick').value.trim(),bio=document.getElementById('editBio').value.trim(),av=document.getElementById('editAv').files[0];if(!nick)return alert('–ü—Å–µ–≤–¥–æ–Ω—ñ–º –æ–±–æ–≤\'—è–∑–∫–æ–≤–∏–π');const newId='@'+nick.toLowerCase(),q=query(collection(db,'users'),where('userId','==',newId)),s=await getDocs(q);if(!s.empty&&s.docs[0].id!==u.uid)return alert('ID –∑–∞–π–Ω—è—Ç–∏–π');try{let avUrl;if(av){const r=ref(storage,`avatars/${u.uid}/${Date.now()}_${av.name}`);await uploadBytes(r,av);avUrl=await getDownloadURL(r)}const up={nickname:nick,userId:newId,nickname_lower:nick.toLowerCase(),bio};avUrl&&(up.avatar=avUrl);await updateDoc(doc(db,'users',u.uid),up);loadMyProfile();document.getElementById('editProfile').classList.remove('active');showToast('–û–Ω–æ–≤–ª–µ–Ω–æ')}catch(e){showToast(e.message)}};function getChatId(a,b){return[a,b].sort().join('_')}async function loadChats(){if(!u)return;const l=document.getElementById('chatList');l.innerHTML='';try{const s=await getDocs(query(collection(db,'chats'),where('participants','array-contains',u.uid)));if(s.empty){l.innerHTML='<p style="text-align:center;padding:16px">–ù–µ–º–∞—î —á–∞—Ç—ñ–≤</p>';return}const items=[];for(const d of s.docs){const chat=d.data(),other=chat.participants.find(id=>id!==u.uid);if(!other)continue;const us=await getDoc(doc(db,'users',other)),user=us.data();if(!user)continue;const un=chat.unread?.[u.uid]||0,last=chat.lastMessage||'',up=chat.updatedAt?.seconds||0,time=up?new Date(up*1e3).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'',lastOn=user.lastOnline?.seconds||0,online=(Date.now()/1e3-lastOn)<60;items.push({chatId:d.id,other,user,un,last,time,online,up,lastOn})}items.sort((a,b)=>b.up-a.up);items.forEach(i=>{const d=document.createElement('div');d.className=`chat-item ${i.un>0?'unread':''}`;d.dataset.chatId=i.chatId;d.dataset.other=i.other;d.tabIndex=0;const ls=i.online?'':getLastSeen(i.lastOn);d.innerHTML=`<div class="avatar small" style="background-image:url(${i.user.avatar||''})"></div><div class="chat-info"><div class="chat-name">${i.user.nickname} ${i.online?'<span class="online-indicator" style="display:inline-block"></span>':''}<span class="last-seen">${ls}</span></div><div class="chat-last">${i.last}</div></div><div class="chat-time">${i.time}</div>${i.un>0?`<div class="chat-badge">${i.un}</div>`:''}`;d.onclick=()=>openChatFromList(i.chatId,i.other,i.user.nickname,i.user.userId,i.user.avatar);l.appendChild(d)})}catch(e){console.error(e);l.innerHTML='<p>–ü–æ–º–∏–ª–∫–∞</p>'}}function getLastSeen(s){if(!s)return'';const d=Date.now()/1e3-s;return d<60?'—â–æ–π–Ω–æ':d<3600?Math.floor(d/60)+' —Ö–≤':d<86400?Math.floor(d/3600)+' –≥–æ–¥':Math.floor(d/86400)+' –¥–Ω'}async function openChatFromList(cid,ouid,name,uid,av){if(!u)return;cp=ouid;cname=name;cid=cid;document.getElementById('chatWin').style.display='flex';document.getElementById('chatName').textContent=name;document.getElementById('chatUserId').textContent=uid||'';document.getElementById('chatAv').style.backgroundImage=`url(${av||''})`;await updateDoc(doc(db,'chats',cid),{[`unread.${u.uid}`]:0});setTimeout(()=>subChat(cid).catch(e=>showToast('–ü–æ–º–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å')),100);uos&&uos();uos=onSnapshot(doc(db,'users',ouid),s=>{const last=s.data()?.lastOnline?.seconds||0,online=(Date.now()/1e3-last)<60;document.getElementById('onlineInd').style.display=online?'inline-block':'none';document.getElementById('lastSeen').textContent=online?'–≤ –º–µ—Ä–µ–∂—ñ':'–±—É–≤ '+getLastSeen(last)})}function openChat(name,ouid,uid){if(!u)return;cp=ouid;cname=name;document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.querySelector('[data-sec="chats"]').classList.add('active');sect.forEach(s=>document.getElementById(s).classList.remove('active'));document.getElementById('chats').classList.add('active');document.getElementById('pt').textContent='–ß–∞—Ç–∏';document.getElementById('chatWin').style.display='flex';document.getElementById('chatName').textContent=name;document.getElementById('chatUserId').textContent=uid||'';getDoc(doc(db,'users',ouid)).then(s=>{if(s.exists()){const av=s.data().avatar||'',last=s.data().lastOnline?.seconds||0,online=(Date.now()/1e3-last)<60;document.getElementById('chatAv').style.backgroundImage=`url(${av})`;document.getElementById('onlineInd').style.display=online?'inline-block':'none';document.getElementById('lastSeen').textContent=online?'–≤ –º–µ—Ä–µ–∂—ñ':'–±—É–≤ '+getLastSeen(last)}});uos&&uos();uos=onSnapshot(doc(db,'users',ouid),s=>{const last=s.data()?.lastOnline?.seconds||0,online=(Date.now()/1e3-last)<60;document.getElementById('onlineInd').style.display=online?'inline-block':'none';document.getElementById('lastSeen').textContent=online?'–≤ –º–µ—Ä–µ–∂—ñ':'–±—É–≤ '+getLastSeen(last)});const cid=getChatId(u.uid,ouid);currentChatId=cid;const ref=doc(db,'chats',cid);getDoc(ref).then(async d=>{if(!d.exists()){await setDoc(ref,{participants:[u.uid,ouid],createdAt:serverTimestamp(),updatedAt:serverTimestamp(),lastMessage:'',unread:{[u.uid]:0,[ouid]:0}})}else await updateDoc(ref,{[`unread.${u.uid}`]:0});setTimeout(()=>subChat(cid).catch(e=>showToast('–ü–æ–º–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å')),100);loadChats()})}function fmtTime(ts){if(!ts)return'';const d=ts.toDate?ts.toDate():new Date(ts.seconds*1e3);return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}function fmtDate(ts){if(!ts)return'';const d=ts.toDate?ts.toDate():new Date(ts.seconds*1e3),t=new Date,y=new Date(t);y.setDate(y.getDate()-1);return d.toDateString()===t.toDateString()?'–°—å–æ–≥–æ–¥–Ω—ñ':d.toDateString()===y.toDateString()?'–í—á–æ—Ä–∞':d.toLocaleDateString()}async function markSeen(cid){if(!u||!cp)return;const q=query(collection(db,`chats/${cid}/messages`),where('from','==',cp),where('seen','==',false)),s=await getDocs(q);if(s.empty)return;const b=writeBatch(db);s.forEach(d=>b.update(d.ref,{seen:true}));await b.commit()}async function subChat(cid){if(!u)throw new Error;uc&&uc();uty&&uty();const msg=document.getElementById('chatMsg'),ous=await getDoc(doc(db,'users',cp)),other=ous.data();let lastD='';uc=onSnapshot(query(collection(db,`chats/${cid}/messages`),orderBy('createdAt')),async s=>{msg.innerHTML='';let hasNew=false;s.forEach(d=>{const m=d.data(),md=fmtDate(m.createdAt);if(md!==lastD){lastD=md;const div=document.createElement('div');div.className='date-divider';div.textContent=md;msg.appendChild(div)}const w=document.createElement('div');w.className=`message-wrapper ${m.from===u.uid?'sent':'received'}`;const b=document.createElement('div');b.className=`message-bubble ${m.from===u.uid?'sent':'received'}`;if(m.from!==u.uid){const snd=document.createElement('div');snd.className='message-sender';snd.innerHTML=`<div class="message-sender-avatar" style="background-image:url(${other?.avatar||''})"></div><span>${cname}</span>`;b.appendChild(snd);m.seen||(hasNew=true)}if(m.fileUrl){if(m.fileType==='image'){const img=document.createElement('img');img.src=m.fileUrl;img.style.maxWidth='100%';img.style.borderRadius='var(--radius-sm)';b.appendChild(img)}else if(m.fileType==='audio'){const a=document.createElement('audio');a.src=m.fileUrl;a.controls=true;a.classList.add('audio-player');b.appendChild(a)}else{const fc=document.createElement('div');fc.className='file-card';fc.innerHTML=`<div class="file-icon">üìÑ</div><div class="file-info"><div class="file-name">${m.fileName||'–§–∞–π–ª'}</div><div class="file-meta">${m.fileSize?(m.fileSize/1024).toFixed(1)+' KB':''}</div></div><a href="${m.fileUrl}" download class="download-btn">‚¨áÔ∏è</a>`;b.appendChild(fc)}}if(m.text){const t=document.createElement('div');t.textContent=m.text;b.appendChild(t)}const tm=document.createElement('div');tm.className='message-time';tm.innerHTML=fmtTime(m.createdAt);if(m.from===u.uid){const s=document.createElement('span');s.className='seen-indicator';s.textContent=m.seen?'‚úì‚úì':'‚úì';tm.appendChild(s)}b.appendChild(tm);w.appendChild(b);msg.appendChild(w)});msg.scrollTo({top:msg.scrollHeight,behavior:'smooth'});hasNew&&await markSeen(cid)},()=>showToast('–ü–æ–º–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å'));if(cp){uty=onSnapshot(doc(db,`chats/${cid}/typing/${cp}`),d=>{const ind=document.getElementById('typing');ind.style.display=d.exists()&&d.data().isTyping?'flex':'none'},()=>{})}}document.getElementById('chatIn').addEventListener('input',()=>{if(!u||!cp||!currentChatId)return;setDoc(doc(db,`chats/${currentChatId}/typing/${u.uid}`),{isTyping:true},{merge:true});clearTimeout(window.ty);window.ty=setTimeout(()=>setDoc(doc(db,`chats/${currentChatId}/typing/${u.uid}`),{isTyping:false},{merge:true}),2e3)});document.getElementById('send').onclick=()=>sendMsg();document.getElementById('chatIn').addEventListener('keypress',e=>{e.key==='Enter'&&!e.shiftKey&&(e.preventDefault(),sendMsg())});async function sendMsg(){const txt=document.getElementById('chatIn').value.trim(),file=document.getElementById('chatFile'),files=file.files;if(!txt&&(!files||!files.length))return;if(!u||!cp||!currentChatId)return;const ref=doc(db,'chats',currentChatId),msgRef=collection(db,`chats/${currentChatId}/messages`);try{if(files.length)for(const f of files){const s=ref(storage,`chat_files/${currentChatId}/${Date.now()}_${f.name}`);await uploadBytes(s,f);const url=await getDownloadURL(s);await addDoc(msgRef,{from:u.uid,text:'',fileUrl:url,fileType:f.type.split('/')[0],fileName:f.name,fileSize:f.size,createdAt:serverTimestamp(),seen:false})}txt&&await addDoc(msgRef,{from:u.uid,text:txt,createdAt:serverTimestamp(),seen:false});await updateDoc(ref,{lastMessage:txt||(files.length?'üìé –§–∞–π–ª':''),updatedAt:serverTimestamp(),[`unread.${cp}`]:increment(1)});document.getElementById('chatIn').value='';file.value='';await setDoc(doc(db,`chats/${currentChatId}/typing/${u.uid}`),{isTyping:false},{merge:true});loadChats()}catch(e){showToast('–ü–æ–º–∏–ª–∫–∞')}}document.getElementById('attach').addEventListener('click',()=>document.getElementById('chatFile').click());let searchT;document.getElementById('chatSearch').addEventListener('input',e=>{clearTimeout(searchT);const v=e.target.value.trim();if(!v){document.getElementById('chatSearchRes').style.display='none';return}searchT=setTimeout(()=>searchChat(v),300)});async function searchChat(q){if(!u)return;const v=q.toLowerCase(),res=document.getElementById('chatSearchRes');res.innerHTML='';const q1=query(collection(db,'users'),where('userId','>=',v.startsWith('@')?v:'@'+v),where('userId','<=',(v.startsWith('@')?v:'@'+v)+'\uf8ff')),q2=query(collection(db,'users'),where('nickname_lower','>=',v),where('nickname_lower','<=',v+'\uf8ff')),[s1,s2]=await Promise.all([getDocs(q1),getDocs(q2)]),m=new Map;s1.forEach(d=>m.set(d.id,d.data()));s2.forEach(d=>m.set(d.id,d.data()));if(!m.size){res.style.display='none';return}res.style.display='block';m.forEach((data,uid)=>{if(uid===u.uid)return;const d=document.createElement('div');d.className='chat-item';d.innerHTML=`<div class="avatar small" style="background-image:url(${data.avatar||''})"></div><div class="chat-info"><div class="chat-name">${data.nickname}</div><div class="chat-last">${data.userId}</div></div><button class="btn">–ù–∞–ø–∏—Å–∞—Ç–∏</button>`;d.onclick=()=>{openChat(data.nickname,uid,data.userId);res.style.display='none';document.getElementById('chatSearch').value=''};d.querySelector('button').onclick=e=>{e.stopPropagation();openChat(data.nickname,uid,data.userId);res.style.display='none';document.getElementById('chatSearch').value=''};res.appendChild(d)})}async function loadSaved(){if(!u)return;const f=document.getElementById('savedFeed');f.innerHTML='';const us=await getDoc(doc(db,'users',u.uid)),ids=us.data().savedPosts||[],posts=[];for(const id of ids.slice(0,20)){const s=await getDoc(doc(db,'posts',id));s.exists()&&posts.push({id,...s.data()})}posts.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));posts.length?renderPosts(posts.map(p=>({id:p.id,data:()=>p})),f):f.innerHTML='<p style="text-align:center;padding:16px">–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö</p>'}document.getElementById('toggleTheme').onclick=()=>{document.body.classList.toggle('dark');localStorage.setItem('theme',document.body.classList.contains('dark')?'dark':'light')};localStorage.getItem('theme')==='dark'&&document.body.classList.add('dark');let tv=localStorage.getItem('tv')==='true';function toggleTv(){tv=!tv;localStorage.setItem('tv',tv);document.body.classList.toggle('tv-mode',tv);if(tv)document.querySelectorAll('.post,.chat-item,.hashtag-item,.profile-tab,.emoji-grid span').forEach(e=>e.setAttribute('tabindex','0'))}tv&&document.body.classList.add('tv-mode');document.getElementById('toggleTv').onclick=toggleTv;document.addEventListener('keydown',e=>{if(!tv)return;const k=e.key,act=document.activeElement,modal=!!document.querySelector('.modal.active');if(k==='Escape'||k==='Back'){e.preventDefault();if(document.querySelector('.modal.active'))return document.querySelector('.modal.active').classList.remove('active');if(sd.classList.contains('open')){closeS();menu.focus();return}if(document.querySelector('.section.active')?.id!=='home')document.querySelector('[data-sec="home"]').click()}if(k.startsWith('Arrow')){e.preventDefault();if(act&&act.closest('.emoji-grid')){const g=act.closest('.emoji-grid'),cells=Array.from(g.querySelectorAll('span')),idx=cells.indexOf(act);if(idx!==-1){let n;const cols=8;k==='ArrowRight'&&(n=idx+1);k==='ArrowLeft'&&(n=idx-1);k==='ArrowDown'&&(n=idx+cols);k==='ArrowUp'&&(n=idx-cols);cells[n]?.focus()}return}const sel='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"]), .post, .chat-item, .hashtag-item, .profile-tab, .avatar[data-uid], .nav-item';let f=Array.from(document.querySelectorAll(sel)).filter(e=>!e.hasAttribute('disabled')&&e.offsetParent);if(modal){const m=document.querySelector('.modal.active');f=f.filter(e=>m.contains(e))}if(!f.length)return;const rect=act?.getBoundingClientRect();if(!rect){f[0].focus();return}const dist=(r,dir)=>{const dx=r.left-rect.left,dy=r.top-rect.top;if(dir==='ArrowRight'&&dx<=0)return 1/0;if(dir==='ArrowLeft'&&dx>=0)return 1/0;if(dir==='ArrowDown'&&dy<=0)return 1/0;if(dir==='ArrowUp'&&dy>=0)return 1/0;return Math.hypot(dx,dy)};let best,bestD=1/0;f.forEach(el=>{if(el===act)return;const d=dist(el.getBoundingClientRect(),k);d<bestD&&(bestD=d,best=el)});best?.focus()}k==='Enter'&&act&&act.tagName!=='INPUT'&&act.tagName!=='TEXTAREA'&&act.tagName!=='SELECT'&&(e.preventDefault(),act.click())});document.getElementById('privacyBtn').onclick=()=>document.getElementById('privacyModal').classList.add('active');document.getElementById('closePrivacy').onclick=()=>document.getElementById('privacyModal').classList.remove('active');document.getElementById('logout').onclick=()=>{cleanup();signOut(auth)};document.addEventListener('click',async e=>{if(!u)return;const t=e.target.closest('button');if(!t)return;if(t.classList.contains('like-btn')){const pid=t.dataset.postId,liked=t.classList.contains('liked'),cnt=t.querySelector('span'),old=parseInt(cnt.textContent);t.classList.toggle('liked');cnt.textContent=liked?old-1:old+1;try{const r=doc(db,'posts',pid);if(liked){await updateDoc(r,{likes:arrayRemove(u.uid),likesCount:increment(-1)});await updateDoc(doc(db,'users',u.uid),{likedPosts:arrayRemove(pid)})}else{await updateDoc(r,{likes:arrayUnion(u.uid),likesCount:increment(1)});await updateDoc(doc(db,'users',u.uid),{likedPosts:arrayUnion(pid)});vibrate(30)}}catch{t.classList.toggle('liked');cnt.textContent=old}}if(t.classList.contains('save-btn')){const pid=t.dataset.postId,saved=t.classList.contains('saved');t.classList.toggle('saved');try{const ur=doc(db,'users',u.uid),pr=doc(db,'posts',pid);if(saved){await updateDoc(ur,{savedPosts:arrayRemove(pid)});await updateDoc(pr,{saves:arrayRemove(u.uid)})}else{await updateDoc(ur,{savedPosts:arrayUnion(pid)});await updateDoc(pr,{saves:arrayUnion(u.uid)})}}catch{t.classList.toggle('saved')}}});document.addEventListener('click',e=>{const uid=e.target.closest('[data-uid]');uid&&viewProfile(uid.dataset.uid)});document.getElementById('lang').value=localStorage.getItem('lang')||'uk';document.getElementById('lang').addEventListener('change',e=>localStorage.setItem('lang',e.target.value));</script></body></html>
