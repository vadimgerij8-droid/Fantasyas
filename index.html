<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FANTASYAS</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Manrope',sans-serif;}
body{background:#000;color:#fff;min-height:100vh;transition:0.4s;}
body.light{background:#fff;color:#111;}

/* Верхня панель */
.top-bar{position:fixed;top:0;left:0;right:0;height:70px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);z-index:1000;transition:0.3s;}
body.light .top-bar{background:rgba(255,255,255,0.9);}
.site-name{font-size:1.7rem;font-weight:800;background:linear-gradient(90deg,#fff,#aaa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;transition:0.3s;}
body.light .site-name{background:linear-gradient(90deg,#000,#444);}

/* Бургер меню */
.burger{width:30px;height:22px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;transition:0.3s;}
.burger span{height:3px;width:100%;background:#fff;border-radius:3px;transition:0.4s;}
body.light .burger span{background:#000;}
.burger.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
.burger.active span:nth-child(2){opacity:0;}
.burger.active span:nth-child(3){transform:rotate(-45deg) translate(6px,-6px);}

/* Бокове меню */
.sidebar{position: fixed;top:0;left:-280px;width:280px;height:100%;background: rgba(0,0,0,0.4);backdrop-filter: blur(10px);padding:100px 30px;border-right:1px solid rgba(255,255,255,0.1);transition:0.4s;z-index:900;}
body.light .sidebar{background: rgba(255,255,255,0.4);backdrop-filter: blur(10px);border-right:1px solid rgba(0,0,0,0.08);}
.sidebar.active{left:0;}
.sidebar a{display:block;color:#aaa;text-decoration:none;font-size:1.2rem;font-weight:600;margin:1.2rem 0;transition:0.3s;}
body.light .sidebar a{color:#555;}
.sidebar a:hover{color:#fff;transform:translateX(6px);}
body.light .sidebar a:hover{color:#000;}

/* Контент */
.main-content{margin-top:80px;padding:20px;}
.section{display:none;opacity:0;transform:translateY(10px);transition:0.3s;}
.section.active{display:block;opacity:1;transform:translateY(0);}

/* Авторизація */
.auth-box{display:flex;flex-direction:column;gap:12px;background:rgba(255,255,255,0.05);padding:20px;border-radius:16px;max-width:400px;margin:auto;margin-top:60px;transition:0.3s;}
body.light .auth-box{background:rgba(0,0,0,0.03);}
.auth-box input{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.08);color:#fff;outline:none;}
body.light .auth-box input{background:#fff;color:#000;border:1px solid #ddd;}
.auth-box button{padding:10px 18px;border:none;border-radius:10px;cursor:pointer;font-weight:700;transition:0.2s, transform 0.2s;background:#444;color:#fff;}
.auth-box button:hover{transform:scale(1.05);opacity:0.9;}

/* Пости */
.feed{display:flex;flex-direction:column;gap:16px;transition:0.3s;}
.post{background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.1);opacity:0;transform:translateY(20px);transition:0.4s;}
.post.show{opacity:1;transform:translateY(0);}
body.light .post{background:rgba(0,0,0,0.03);}
.post-header{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.avatar{width:45px;height:45px;border-radius:50%;background:#444;background-size:cover;background-position:center;}
body.light .avatar{background:#ccc;}
.username{font-weight:700;}
.post-content{margin-bottom:8px;}

/* Профіль */
.profile-avatar{width:100px;height:100px;border-radius:50%;background:#333;background-size:cover;margin-bottom:10px;}
body.light .profile-avatar{background:#ddd;}
.profile-edit-form{display:flex;flex-direction:column;gap:12px;}
.profile-stats{display:flex;gap:15px;margin-top:8px;font-weight:600;}
.follow-btn{margin-top:10px;padding:8px 14px;border-radius:10px;font-weight:700;background:#555;color:#fff;cursor:pointer;transition:0.3s;}
.follow-btn.following{background:#0a84ff;color:#fff;transform:scale(1.05);}
.follow-btn:hover{opacity:0.9;}

/* Модалки */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:2000;transition:0.3s;}
.modal.active{display:flex;}
.modal-content{background:#111;width:90%;max-width:500px;border-radius:16px;padding:24px;position:relative;border:1px solid rgba(255,255,255,0.15);}
body.light .modal-content{background:#fff;color:#000;}
.close-modal{position:absolute;top:12px;right:16px;font-size:1.8rem;cursor:pointer;color:#aaa;}
body.light .close-modal{color:#555;}

/* Додаткові стилі для постів, коментарів, лайків і чатів */
.post-actions{display:flex;align-items:center;gap:12px;margin-top:12px;}
.like-btn,.comment-btn,.add-comment{padding:8px 14px;background:rgba(255,255,255,0.1);border:none;border-radius:10px;cursor:pointer;color:#fff;font-weight:600;transition:0.2s;}
.like-btn:hover,.comment-btn:hover,.add-comment:hover{background:rgba(255,255,255,0.2);}
body.light .like-btn, body.light .comment-btn, body.light .add-comment{background:rgba(0,0,0,0.05);color:#000;}
body.light .like-btn:hover, body.light .comment-btn:hover, body.light .add-comment:hover{background:rgba(0,0,0,0.1);}
.comment{padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;margin-top:6px;}
body.light .comment{background:rgba(0,0,0,0.03);}
.comment-username{font-weight:700;}
.chats{display:flex;flex-direction:column;gap:12px;}
.chat-item{padding:12px;background:rgba(255,255,255,0.05);border-radius:10px;cursor:pointer;transition:0.3s;}
.chat-item:hover{background:rgba(255,255,255,0.1);}
body.light .chat-item{background:rgba(0,0,0,0.03);}
body.light .chat-item:hover{background:rgba(0,0,0,0.06);}
.message{padding:8px;margin-top:6px;border-radius:8px;background:rgba(255,255,255,0.05);}
body.light .message{background:rgba(0,0,0,0.03);}

@media(max-width:900px){.sidebar{width:100%;left:-100%;border-right:none;}}
</style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">Головна</a>
  <a data-section="profile">Профіль</a>
  <a data-section="messages">Повідомлення</a>
  <a data-section="groups">Групи</a>
  <a data-section="settings">Налаштування</a>
</nav>

<main class="main-content">

  <!-- Авторизація -->
  <div id="home" class="section active">
    <div class="auth-box" id="authBox">
      <input type="text" id="usernameInput" placeholder="Ім'я користувача">
      <input type="email" id="emailInput" placeholder="Email">
      <input type="password" id="passwordInput" placeholder="Пароль">
      <button id="loginBtn">Увійти</button>
      <button id="registerBtn">Зареєструватися</button>
    </div>
    <div class="new-post" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="Що у тебе на думці?..." rows="4"></textarea>
      <input type="file" id="postImage" accept="image/*"/>
      <button id="addPost">Опублікувати</button>
    </div>
    <div class="feed" id="feed"></div>
  </div>

  <!-- Профіль -->
  <div id="profile" class="section">
    <div class="profile-header">
      <div class="profile-avatar" id="profileAvatar"></div>
      <div>
        <h2 id="profileUsernameDisplay"></h2>
        <p id="profileBio">Немає опису</p>
        <div class="profile-stats">
          <span id="postsCount">Пости: 0</span>
          <span id="followersCount">Підписники: 0</span>
          <span id="followingCount">Підписки: 0</span>
        </div>
        <button id="followBtn" class="follow-btn" style="display:none;">Підписатися</button>
      </div>
      <button id="editProfileBtn">Редагувати профіль</button>
    </div>
  </div>

  <!-- Повідомлення -->
  <div id="messages" class="section">
    <h2>Повідомлення</h2>
    <div class="chats">
      <input type="text" id="chatUserInput" placeholder="Ім'я користувача">
      <button id="startChat">Почати чат</button>
      <div id="chatList"></div>
      <div id="currentChat" style="display:none;">
        <h3 id="chatWith"></h3>
        <div id="messagesList" style="height:300px; overflow-y:auto; border:1px solid rgba(255,255,255,0.1); padding:10px; border-radius:8px;"></div>
        <input type="text" id="messageInput" placeholder="Повідомлення...">
        <button id="sendMessage">Надіслати</button>
      </div>
    </div>
  </div>

  <div id="groups" class="section"><h2>Групи</h2></div>
  <div id="settings" class="section"><h2>Налаштування</h2><button id="toggleTheme">Світла/Темна тема</button></div>
</main>

<!-- Модалка редагування -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">&times;</span>
    <h2>Редагувати профіль</h2>
    <div class="profile-edit-form">
      <input type="file" id="editAvatarFile"/>
      <textarea id="editBio" rows="4" placeholder="Опис профілю..."></textarea>
      <button id="saveProfileEdit">Зберегти</button>
    </div>
  </div>
</div>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "ВАШ_API_KEY",
  authDomain: "ВАШ_PROJECT.firebaseapp.com",
  databaseURL: "https://ВАШ_PROJECT.firebaseio.com",
  projectId: "ВАШ_PROJECT",
  storageBucket: "ВАШ_PROJECT.appspot.com",
  messagingSenderId: "ВАШ_ID",
  appId: "ВАШ_APPID"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();

// Змінні
let currentUser=null;
let userData={username:'', avatar:'', bio:'', followers:[], following:[], chats:{}};
let currentProfileUid = null;
let currentChatId = null;
let currentOtherUid = null;

// Бургер меню
const burger=document.getElementById('burger');
const sidebar=document.getElementById('sidebar');
burger.addEventListener('click',()=>{burger.classList.toggle('active');sidebar.classList.toggle('active');});

// Секції
const sections=document.querySelectorAll('.section');
document.querySelectorAll('[data-section]').forEach(el=>{
  el.addEventListener('click',()=>{
    sections.forEach(s=>s.classList.remove('active'));
    const section = document.getElementById(el.dataset.section);
    section.classList.add('active');
    if(el.dataset.section === 'profile') {
      showProfile(currentUser.uid);
    }
    sidebar.classList.remove('active'); burger.classList.remove('active');
  });
});

// Авторизація
const authBox=document.getElementById('authBox');
const newPostBox=document.getElementById('newPostBox');
const usernameInput=document.getElementById('usernameInput');
const emailInput=document.getElementById('emailInput');
const passwordInput=document.getElementById('passwordInput');
const profileUsernameDisplay=document.getElementById('profileUsernameDisplay');
const profileAvatar=document.getElementById('profileAvatar');
const profileBio=document.getElementById('profileBio');
const postsCount=document.getElementById('postsCount');
const followersCount=document.getElementById('followersCount');
const followingCount=document.getElementById('followingCount');
const followBtn=document.getElementById('followBtn');
const editProfileBtn=document.getElementById('editProfileBtn');

document.getElementById('registerBtn').addEventListener('click',()=>{
  const username = usernameInput.value.trim();
  const email = emailInput.value;
  const pass = passwordInput.value;
  if(!username || !email || !pass) return alert('Заповніть всі поля');
  db.ref(`usernames/${username}`).once('value').then(snap => {
    if(snap.val()) return alert('Ім\'я користувача зайняте');
    auth.createUserWithEmailAndPassword(email,pass).then(res=>{
      currentUser=res.user;
      userData = {username, email, followers:[], following:[], avatar:'', bio:'', chats:{}};
      db.ref(`users/${currentUser.uid}`).set(userData);
      db.ref(`usernames/${username}`).set(currentUser.uid);
      afterLogin();
    }).catch(err=>alert(err.message));
  });
});

document.getElementById('loginBtn').addEventListener('click',()=>{
  const email = emailInput.value;
  const pass = passwordInput.value;
  if(!email || !pass) return alert('Введіть email і пароль');
  auth.signInWithEmailAndPassword(email,pass)
    .then(res=>{currentUser=res.user; afterLogin();})
    .catch(err=>alert(err.message));
});

function afterLogin(){
  authBox.style.display='none';
  newPostBox.style.display='block';
  loadUserData();
}

// Завантаження даних користувача
function loadUserData(){
  db.ref(`users/${currentUser.uid}`).on('value', snap=>{
    userData = snap.val() || {username:'', avatar:'', bio:'', followers:[], following:[], chats:{}};
    if(currentProfileUid === currentUser.uid){
      showProfile(currentUser.uid);
    }
  });
}

// Показ профілю
function showProfile(uid){
  currentProfileUid = uid;
  if(uid === currentUser.uid){
    editProfileBtn.style.display = 'block';
    followBtn.style.display = 'none';
    profileAvatar.style.backgroundImage = `url('${userData.avatar || ''}')`;
    profileUsernameDisplay.innerText = userData.username || currentUser.email;
    profileBio.innerText = userData.bio || 'Немає опису';
    followersCount.innerText = `Підписники: ${userData.followers.length}`;
    followingCount.innerText = `Підписки: ${userData.following.length}`;
    updatePostsCount(uid);
  } else {
    editProfileBtn.style.display = 'none';
    followBtn.style.display = 'block';
    db.ref(`users/${uid}`).once('value', snap=>{
      const ud = snap.val();
      profileAvatar.style.backgroundImage = `url('${ud.avatar || ''}')`;
      profileUsernameDisplay.innerText = ud.username || ud.email;
      profileBio.innerText = ud.bio || 'Немає опису';
      followersCount.innerText = `Підписники: ${ud.followers.length}`;
      followingCount.innerText = `Підписки: ${ud.following.length}`;
      const isFollowing = userData.following.includes(uid);
      followBtn.innerText = isFollowing ? 'Відписатися' : 'Підписатися';
      followBtn.classList.toggle('following', isFollowing);
    });
    updatePostsCount(uid);
  }
}

function updatePostsCount(uid){
  db.ref('posts').once('value', snap=>{
    const posts = snap.val() || {};
    const count = Object.values(posts).filter(p=>p.uid===uid).length;
    postsCount.innerText=`Пости: ${count}`;
  });
}

// Підписка/відписка
followBtn.addEventListener('click',()=>{
  if(!currentProfileUid || currentProfileUid === currentUser.uid) return;
  const isFollowing = userData.following.includes(currentProfileUid);
  db.ref(`users/${currentUser.uid}/following`).transaction(fol=>{
    fol = fol || [];
    if(isFollowing){
      return fol.filter(u=>u!==currentProfileUid);
    } else {
      fol.push(currentProfileUid);
      return fol;
    }
  }).then(()=>{
    db.ref(`users/${currentProfileUid}/followers`).transaction(fol=>{
      fol = fol || [];
      if(isFollowing){
        return fol.filter(u=>u!==currentUser.uid);
      } else {
        fol.push(currentUser.uid);
        return fol;
      }
    }).then(()=>{
      showProfile(currentProfileUid);
    });
  });
});

// Новий пост
document.getElementById('addPost').addEventListener('click',()=>{
  const text=document.getElementById('postText').value.trim();
  if(!text||!currentUser) return;
  const file=document.getElementById('postImage').files[0];
  const postData = {uid:currentUser.uid, username:userData.username, avatar:userData.avatar, text, image:null, time:Date.now(), likes:[], comments:{}};
  if(file){
    const reader=new FileReader();
    reader.onload=e=>{
      postData.image = e.target.result;
      db.ref('posts').push(postData);
      document.getElementById('postText').value=''; document.getElementById('postImage').value='';
    };
    reader.readAsDataURL(file);
  }else{
    db.ref('posts').push(postData);
    document.getElementById('postText').value='';
  }
});

// Пости
const feed=document.getElementById('feed');
db.ref('posts').on('value',snap=>{
  feed.innerHTML='';
  const data=snap.val();
  if(!data) return;
  Object.entries(data).sort((a,b)=>b[1].time - a[1].time).forEach(([key, p])=>{
    let commentsHtml = '';
    if(p.comments){
      Object.values(p.comments).forEach(c=>{
        commentsHtml += `<div class="comment"><span class="comment-username">${c.username}:</span> ${c.text}</div>`;
      });
    }
    const div=document.createElement('div');
    div.className='post';
    div.innerHTML=`
      <div class="post-header">
        <div class="avatar" style="background-image:url('${p.avatar||''}')"></div>
        <div class="username" data-uid="${p.uid}">${p.username}</div>
      </div>
      <div class="post-content">${p.text}${p.image?`<img src="${p.image}" style="max-width:100%;margin-top:8px;border-radius:8px;"/>`:''}</div>
      <div class="post-actions">
        <button data-postid="${key}" class="like-btn">Лайк <span class="like-count">${p.likes ? p.likes.length : 0}</span></button>
        <button data-postid="${key}" class="comment-btn">Коментарі (${p.comments ? Object.keys(p.comments).length : 0})</button>
      </div>
      <div class="comments" id="comments-${key}" style="display:none;">
        <div class="comment-list">${commentsHtml}</div>
        <input class="comment-input" placeholder="Додати коментар..."/>
        <button class="add-comment">Надіслати</button>
      </div>
    `;
    feed.appendChild(div);
    setTimeout(()=>{div.classList.add('show');},50);
  });
});

// Дії з постами
feed.addEventListener('click', e=>{
  if(e.target.classList.contains('like-btn')){
    const postid = e.target.dataset.postid;
    db.ref(`posts/${postid}/likes`).transaction(likes=>{
      likes = likes || [];
      if(likes.includes(currentUser.uid)){
        return likes.filter(u=>u!==currentUser.uid);
      } else {
        likes.push(currentUser.uid);
        return likes;
      }
    });
  }
  if(e.target.classList.contains('comment-btn')){
    const postid = e.target.dataset.postid;
    const comm = document.getElementById(`comments-${postid}`);
    comm.style.display = comm.style.display === 'none' ? 'block' : 'none';
  }
  if(e.target.classList.contains('add-comment')){
    const commentsDiv = e.target.closest('.comments');
    const postid = commentsDiv.id.split('-')[1];
    const input = commentsDiv.querySelector('.comment-input');
    const text = input.value.trim();
    if(text){
      db.ref(`posts/${postid}/comments`).push({uid:currentUser.uid, username:userData.username, text, time:Date.now()});
      input.value = '';
    }
  }
  if(e.target.classList.contains('username')){
    showProfile(e.target.dataset.uid);
    sections.forEach(s=>s.classList.remove('active'));
    document.getElementById('profile').classList.add('active');
  }
});

// Редагування профілю
const editModal=document.getElementById('editProfileModal');
editProfileBtn.addEventListener('click',()=>editModal.classList.add('active'));
document.getElementById('closeModal').addEventListener('click',()=>editModal.classList.remove('active'));
document.getElementById('saveProfileEdit').addEventListener('click',()=>{
  const file=document.getElementById('editAvatarFile').files[0];
  const bio=document.getElementById('editBio').value;
  if(file){
    const reader=new FileReader();
    reader.onload=e=>{
      userData.avatar = e.target.result;
      db.ref(`users/${currentUser.uid}`).update({avatar:userData.avatar});
    };
    reader.readAsDataURL(file);
  }
  userData.bio = bio;
  db.ref(`users/${currentUser.uid}`).update({bio});
  editModal.classList.remove('active');
});

// Тема
document.getElementById('toggleTheme').addEventListener('click',()=>document.body.classList.toggle('light'));

// Чати
const chatUserInput = document.getElementById('chatUserInput');
const startChat = document.getElementById('startChat');
const chatList = document.getElementById('chatList');
const currentChat = document.getElementById('currentChat');
const chatWith = document.getElementById('chatWith');
const messagesList = document.getElementById('messagesList');
const messageInput = document.getElementById('messageInput');
const sendMessage = document.getElementById('sendMessage');
const messagesSection = document.getElementById('messages');

startChat.addEventListener('click', () => {
  const targetUsername = chatUserInput.value.trim();
  if(!targetUsername) return;
  db.ref(`usernames/${targetUsername}`).once('value').then(snap => {
    const targetUid = snap.val();
    if(!targetUid) return alert('Користувача не знайдено');
    if(targetUid === currentUser.uid) return alert('Не можна чат з собою');
    db.ref(`users/${currentUser.uid}/chats/${targetUid}`).set(targetUsername);
    db.ref(`users/${targetUid}/chats/${currentUser.uid}`).set(userData.username);
    chatUserInput.value = '';
  });
});

db.ref(`users/${currentUser ? currentUser.uid : ''}/chats`).on('value', snap => {
  if(!currentUser) return;
  chatList.innerHTML = '';
  const chats = snap.val() || {};
  Object.entries(chats).forEach(([ouid, uname]) => {
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.dataset.ouid = ouid;
    div.dataset.uname = uname;
    div.textContent = uname;
    chatList.appendChild(div);
  });
});

messagesSection.addEventListener('click', e => {
  if(e.target.classList.contains('chat-item')){
    currentOtherUid = e.target.dataset.ouid;
    const uname = e.target.dataset.uname;
    chatWith.textContent = `Чат з ${uname}`;
    currentChatId = [currentUser.uid, currentOtherUid].sort().join('_');
    currentChat.style.display = 'block';
    db.ref(`messages/${currentChatId}`).off();
    db.ref(`messages/${currentChatId}`).on('value', snap => {
      messagesList.innerHTML = '';
      const msgs = snap.val() || {};
      Object.values(msgs).sort((a,b)=>a.time - b.time).forEach(m => {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `<span class="username">${m.username}:</span> ${m.text}`;
        messagesList.appendChild(div);
      });
      messagesList.scrollTop = messagesList.scrollHeight;
    });
  }
});

sendMessage.addEventListener('click', () => {
  const text = messageInput.value.trim();
  if(!text || !currentChatId) return;
  db.ref(`messages/${currentChatId}`).push({
    username: userData.username,
    uid: currentUser.uid,
    text,
    time: Date.now()
  });
  messageInput.value = '';
});

</script>
</body>
</html>
