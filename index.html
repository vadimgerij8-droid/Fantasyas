<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FANTASYAS ¬∑ –æ–Ω–æ–≤–ª–µ–Ω–∏–π</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Manrope', sans-serif;
    }

    :root {
      --bg: #000000;
      --surface: rgba(17, 17, 17, 0.6);
      --card: rgba(26, 26, 26, 0.5);
      --border: rgba(255, 255, 255, 0.1);
      --text: #ffffff;
      --text-sec: #aaaaaa;
      --accent: #888888;
      --hover: rgba(44, 44, 44, 0.7);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      --blur: blur(10px);
      --font-scale: 1;
      --post-padding: 24px;
      --avatar-size: 52px;
      --font-size-base: 1rem;
    }

    body.light {
      --bg: #f8f8f8;
      --surface: rgba(255, 255, 255, 0.6);
      --card: rgba(238, 238, 238, 0.5);
      --border: rgba(0, 0, 0, 0.1);
      --text: #111111;
      --text-sec: #555555;
      --accent: #666666;
      --hover: rgba(224, 224, 224, 0.7);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    /* ===== –¢–ï–õ–ï–í–Ü–ó–û–† ===== */
    body.tv {
      --font-scale: 1.6;
      --post-padding: 48px;
      --avatar-size: 100px;
      --font-size-base: 1.3rem;
    }

    body.tv .post { margin-bottom: 48px; }
    body.tv .post-header { gap: 28px; }
    body.tv .username { font-size: 2rem; }
    body.tv .post-content { font-size: 1.8rem; line-height: 1.5; }
    body.tv .post-footer button { font-size: 2rem; gap: 20px; padding: 16px 32px; }
    body.tv .subscribe-post-btn { font-size: 1.6rem; padding: 14px 32px; }
    body.tv .comments-section { margin-top: 48px; }
    body.tv .comment .avatar { width: 70px; height: 70px; }
    body.tv .comment-content { font-size: 1.6rem; padding: 18px 28px; }
    body.tv .comment-input-area textarea { font-size: 1.6rem; padding: 18px 28px; }
    body.tv .top-bar { height: 120px; }
    body.tv .site-name { font-size: 3.2rem; }
    body.tv .burger { width: 56px; height: 38px; }
    body.tv .burger span { height: 5px; }
    body.tv .sidebar a { font-size: 2.2rem; margin: 3rem 0; }
    body.tv .card { padding: 48px; }
    body.tv input, body.tv textarea, body.tv button { font-size: 1.6rem; padding: 20px 32px; }
    body.tv :focus {
      outline: 4px solid var(--accent);
      outline-offset: 6px;
    }

    /* ===== –ó–ê–ì–ê–õ–¨–ù–Ü –°–¢–ò–õ–Ü ===== */
    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.25s, color 0.25s;
      font-size: calc(var(--font-size-base) * var(--font-scale));
    }

    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: var(--surface);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: all 0.3s ease;
    }
    .top-bar:hover {
      background: var(--hover);
    }

    .site-name {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(145deg, #fff, #aaa);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
      animation: gradient-shift 5s infinite;
    }
    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    body.light .site-name { background: linear-gradient(145deg, #111, #555); -webkit-background-clip: text; }

    .burger {
      width: 32px;
      height: 22px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }
    .burger span {
      height: 3px;
      width: 100%;
      background: var(--text);
      border-radius: 6px;
      transition: 0.3s cubic-bezier(0.68, -0.6, 0.32, 1.6);
    }
    .burger.active span:nth-child(1) { transform: rotate(45deg) translate(7px, 6px); }
    .burger.active span:nth-child(2) { opacity: 0; transform: scale(0); }
    .burger.active span:nth-child(3) { transform: rotate(-45deg) translate(7px, -6px); }

    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 280px;
      height: 100%;
      background: var(--surface);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      padding: 100px 28px;
      border-right: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: left 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 999;
    }
    body.tv .sidebar { width: 350px; left: -350px; }
    .sidebar.active { left: 0; }

    .sidebar a {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-sec);
      text-decoration: none;
      font-size: 1.3rem;
      font-weight: 600;
      margin: 2rem 0;
      transition: 0.2s;
      position: relative;
      width: fit-content;
    }
    .sidebar a .icon-svg {
      width: 28px;
      height: 28px;
      stroke: var(--text-sec);
      stroke-width: 1.8;
      fill: none;
      transition: stroke 0.2s, transform 0.2s;
    }
    .sidebar a:hover .icon-svg {
      stroke: var(--text);
      transform: scale(1.1) rotate(5deg);
    }
    .sidebar a:hover {
      color: var(--text);
      transform: translateX(8px);
    }
    .sidebar a::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--accent);
      transition: width 0.2s;
    }
    .sidebar a:hover::after { width: 100%; }

    .badge {
      background: #ff4444;
      color: white;
      border-radius: 50%;
      padding: 2px 8px;
      font-size: 0.8rem;
      margin-left: 8px;
      display: inline-block;
      animation: pulse-badge 1.5s infinite;
    }
    @keyframes pulse-badge {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .main-content {
      margin-top: 90px;
      padding: 20px;
      max-width: 680px;
      margin-left: auto;
      margin-right: auto;
    }
    body.tv .main-content { max-width: 1000px; }

    .section { display: none; opacity: 0; transform: translateY(20px); transition: 0.4s; }
    .section.active { display: block; opacity: 1; transform: translateY(0); }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      transition: 0.25s;
    }
    .card:hover { border-color: var(--accent); transform: translateY(-5px); }

    input, textarea {
      width: 100%;
      padding: 16px 20px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: 0.2s;
      backdrop-filter: var(--blur);
    }
    input:focus, textarea:focus { border-color: var(--accent); background: var(--card); transform: scale(1.01); }
    ::placeholder { color: var(--text-sec); opacity: 0.5; }

    button {
      padding: 14px 26px;
      border: none;
      border-radius: 40px;
      background: var(--surface);
      color: var(--text);
      font-weight: 600;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: 0.2s;
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      position: relative;
      overflow: hidden;
    }
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.5s, height 0.5s;
    }
    button:active::before {
      width: 200%;
      height: 200%;
    }
    button:hover {
      background: var(--hover);
      transform: scale(1.02);
      border-color: var(--accent);
    }

    /* –°–∫–µ–ª–µ—Ç–æ–Ω */
    .skeleton-post {
      background: linear-gradient(90deg, var(--card) 25%, var(--hover) 50%, var(--card) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 28px;
      height: 200px;
      margin-bottom: 24px;
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* –°—Ç—Ä—ñ—á–∫–∞ */
    .feed-header {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      justify-content: center;
    }
    .feed-header button {
      flex: 1;
      max-width: 200px;
      background: var(--surface);
      border: 1px solid var(--border);
      font-size: 1.1rem;
      padding: 12px 20px;
      backdrop-filter: var(--blur);
      transition: all 0.3s ease;
    }
    .feed-header button.active {
      background: var(--accent);
      color: black;
      border-color: var(--accent);
      transform: scale(1.05);
    }

    .popular-search { margin-bottom: 20px; }
    .feed { display: flex; flex-direction: column; gap: 24px; }

    .post {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: var(--post-padding);
      opacity: 0;
      transform: translateY(30px) scale(0.98);
      transition: opacity 0.6s cubic-bezier(0.2, 0.9, 0.3, 1), transform 0.6s cubic-bezier(0.2, 0.9, 0.3, 1), box-shadow 0.3s;
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
    }
    .post.show { opacity: 1; transform: translateY(0) scale(1); }
    .post:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
      border-color: var(--accent);
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
      position: relative;
      flex-wrap: wrap;
    }
    .avatar {
      width: var(--avatar-size);
      height: var(--avatar-size);
      border-radius: 50%;
      background: #333;
      background-size: cover;
      background-position: center;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: 0.2s;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    .avatar:hover { border-color: var(--accent); transform: scale(1.05) rotate(5deg); box-shadow: 0 0 15px rgba(255,255,255,0.2); }
    .post-user {
      display: flex;
      flex-direction: column;
    }
    .username {
      font-weight: 700;
      font-size: 1.15rem;
      cursor: pointer;
      text-decoration: none;
      color: var(--text);
      transition: color 0.2s;
    }
    .username:hover { text-decoration: underline; color: var(--accent); }
    .user-id-small {
      color: var(--accent);
      font-size: 0.85rem;
    }
    .edit-post-btn {
      background: none;
      border: none;
      margin-left: auto;
      cursor: pointer;
    }
    .edit-post-btn svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-sec);
      transition: stroke 0.2s, transform 0.2s;
    }
    .edit-post-btn:hover svg {
      stroke: var(--text);
      transform: scale(1.1) rotate(10deg);
    }
    .menu-btn {
      margin-left: 8px;
      font-size: 2rem;
      line-height: 1;
      background: none;
      border: none;
      color: var(--text-sec);
      padding: 0 8px;
      cursor: pointer;
      transition: transform 0.2s, color 0.2s;
    }
    .menu-btn:hover { color: var(--text); transform: scale(1.2) rotate(90deg); background: none; border: none; }

    .subscribe-post-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 6px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-left: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: var(--blur);
    }
    .subscribe-post-btn:hover {
      background: var(--accent);
      color: black;
      border-color: var(--accent);
      transform: scale(1.05) rotate(2deg);
    }
    .subscribe-post-btn:active {
      animation: pulse 0.3s ease;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .post-content {
      font-size: 1.05rem;
      line-height: 1.6;
      margin-bottom: 16px;
      word-break: break-word;
      transition: all 0.3s ease;
    }
    .post-content:hover {
      transform: translateX(5px);
    }

    .truncated + .show-more {
      background: none;
      border: none;
      color: var(--accent);
      font-weight: 600;
      padding: 4px 8px;
      cursor: pointer;
      transition: color 0.2s;
    }
    .truncated + .show-more:hover {
      color: var(--text);
    }

    .post-media {
      width: 100%;
      border-radius: 24px;
      margin: 16px 0;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .post-media:hover {
      transform: scale(1.02);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* ===== –ù–û–í–Ü –Ü–ö–û–ù–ö–ò –Ø–ö –í INSTAGRAM ===== */
    .post-footer {
      display: flex;
      gap: 28px;
      margin: 16px 0 8px;
    }

    .post-footer button {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
      padding: 6px 12px;
      border-radius: 40px;
      color: var(--text-sec);
      transition: all 0.3s ease;
    }

    .post-footer button:hover {
      background: var(--hover);
      color: var(--text);
      transform: scale(1.1);
      border: none;
    }

    /* like button ‚Äì —Å–µ—Ä–¥–µ—á–∫–æ –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é */
    .like-btn svg {
      width: 28px;
      height: 28px;
      fill: transparent;
      stroke: var(--text-sec);
      stroke-width: 2;
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .like-btn.liked svg {
      fill: #ff3040;
      stroke: #ff3040;
      animation: heartPop 0.45s ease;
    }

    @keyframes heartPop {
      0% { transform: scale(1); }
      30% { transform: scale(1.3); }
      60% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }

    /* comment button ‚Äì –∑–Ω–∞—á–æ–∫ –∫–æ–º–µ–Ω—Ç–∞—Ä—è */
    .comments-toggle svg {
      width: 26px;
      height: 26px;
      stroke: var(--text-sec);
      stroke-width: 2;
      fill: none;
      transition: stroke 0.2s, transform 0.2s;
    }

    .comments-toggle:hover svg {
      stroke: var(--text);
      transform: rotate(-5deg) scale(1.1);
    }

    .comments-toggle:active svg {
      transform: scale(0.9);
    }

    .comments-section {
      margin-top: 24px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
      transition: height 0.3s ease;
    }
    .comment {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      animation: fadeSlideUp 0.4s ease;
    }
    @keyframes fadeSlideUp {
      0% { opacity: 0; transform: translateY(15px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .comment .avatar { width: 36px; height: 36px; }
    .comment-content {
      background: var(--surface);
      padding: 12px 16px;
      border-radius: 22px;
      flex: 1;
      border: 1px solid var(--border);
      backdrop-filter: var(--blur);
      transition: transform 0.2s ease;
    }
    .comment-content:hover {
      transform: translateY(-3px);
    }
    .comment-author { font-weight: 700; margin-right: 8px; cursor: pointer; }
    .comment-author:hover { text-decoration: underline; color: var(--accent); }

    .comment-input-area {
      display: flex;
      gap: 10px;
      margin: 16px 0 8px;
    }
    .comment-input-area textarea {
      flex: 1;
      min-height: 44px;
      border-radius: 30px;
      padding: 12px 18px;
      transition: box-shadow 0.3s ease;
    }
    .comment-input-area textarea:focus {
      box-shadow: 0 0 10px var(--accent);
    }

    .emoji-panel {
      display: flex;
      gap: 8px;
      background: var(--surface);
      border-radius: 40px;
      padding: 8px 14px;
      border: 1px solid var(--border);
      width: fit-content;
      margin-bottom: 10px;
      backdrop-filter: var(--blur);
    }
    .emoji-panel span {
      font-size: 1.8rem;
      cursor: pointer;
      transition: 0.15s;
      filter: grayscale(20%);
    }
    .emoji-panel span:hover { transform: scale(1.3) rotate(15deg); filter: grayscale(0); }

    /* –ü–æ—à—É–∫ */
    .search-input {
      margin-bottom: 24px;
      padding: 18px 24px;
      font-size: 1.1rem;
      transition: box-shadow 0.3s ease;
    }
    .search-input:focus {
      box-shadow: 0 0 15px var(--accent);
    }
    .user-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-radius: 28px;
      background: var(--card);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      cursor: pointer;
      transition: 0.2s;
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
    }
    .user-item:hover { border-color: var(--accent); transform: translateX(6px) scale(1.02); }
    .user-id { color: var(--accent); font-size: 0.9rem; }
    .follow-btn {
      margin-left: auto;
      background: var(--accent);
      color: black;
      font-weight: 700;
      padding: 8px 22px;
      border-radius: 40px;
      border: none;
      transition: all 0.3s ease;
    }
    .follow-btn:hover {
      transform: scale(1.05) rotate(-3deg);
    }

    /* –ß–∞—Ç */
    .chat-list { display: flex; flex-direction: column; gap: 8px; max-height: 70vh; overflow-y: auto; }
    .chat-item {
      display: flex; align-items: center; gap: 16px; padding: 16px; border-radius: 24px;
      background: var(--card); border: 1px solid var(--border); cursor: pointer; transition: 0.2s;
      backdrop-filter: var(--blur);
    }
    .chat-item:hover { background: var(--hover); border-color: var(--accent); transform: translateY(-3px); }
    .chat-item.unread { background: rgba(255,255,255,0.05); border-left: 4px solid var(--accent); }
    .chat-avatar { width: 56px; height: 56px; border-radius: 50%; background-size: cover; border: 2px solid var(--border); transition: transform 0.3s ease; }
    .chat-avatar:hover { transform: scale(1.1); }
    .chat-info { flex: 1; min-width: 0; }
    .chat-name { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .chat-userid { color: var(--accent); font-size: 0.85rem; }
    .chat-last { color: var(--text-sec); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .chat-time { color: var(--text-sec); font-size: 0.75rem; }
    .chat-badge { background: var(--accent); color: black; border-radius: 50%; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; animation: bounce 0.5s ease; }
    @keyframes bounce {
      0% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0); }
    }

    .chat-window {
      display: none; flex-direction: column; height: 70vh; border: 1px solid var(--border); border-radius: 32px;
      overflow: hidden; background: var(--card); margin-top: 20px;
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      transition: transform 0.3s ease;
    }
    .chat-window:hover {
      transform: translateY(-5px);
    }
    .chat-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; background: var(--surface); }
    .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    .message { max-width: 75%; padding: 12px 18px; border-radius: 26px; animation: messagePop 0.3s; word-break: break-word; backdrop-filter: var(--blur); transition: transform 0.2s ease; }
    .message:hover { transform: scale(1.02); }
    .message.sent { background: var(--accent); color: black; align-self: flex-end; border-bottom-right-radius: 6px; }
    .message.received { background: var(--surface); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 6px; }
    .chat-input { display: flex; padding: 16px; border-top: 1px solid var(--border); background: var(--surface); }
    .chat-input input { flex: 1; margin-right: 16px; border-radius: 40px; transition: box-shadow 0.3s ease; }
    .chat-input input:focus { box-shadow: 0 0 10px var(--accent); }

    /* –ü—Ä–æ—Ñ—ñ–ª—å */
    .profile-header { display: flex; flex-wrap: wrap; gap: 28px; align-items: center; position: relative; }
    .profile-header.sticky { position: sticky; top: 70px; background: var(--surface); backdrop-filter: var(--blur); z-index: 900; padding: 16px; border-radius: 28px; }
    .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: #333; background-size: cover; border: 3px solid var(--border); cursor: pointer; transition: 0.2s; box-shadow: 0 0 15px rgba(255,255,255,0.1); }
    .profile-avatar:hover { border-color: var(--accent); transform: scale(1.02) rotate(5deg); box-shadow: 0 0 20px rgba(255,255,255,0.2); }
    .edit-profile-btn {
      background: none;
      border: none;
      margin-left: auto;
      cursor: pointer;
    }
    .edit-profile-btn svg {
      width: 28px;
      height: 28px;
      stroke: var(--text-sec);
      transition: stroke 0.2s, transform 0.2s;
    }
    .edit-profile-btn:hover svg { stroke: var(--text); transform: rotate(90deg); }

    .profile-tabs {
      display: flex;
      gap: 12px;
      margin: 24px 0;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    .profile-tab {
      background: none;
      border: none;
      color: var(--text-sec);
      font-size: 1.1rem;
      padding: 8px 16px;
      border-radius: 30px;
      transition: 0.2s;
    }
    .profile-tab.active {
      background: var(--accent);
      color: black;
      transform: scale(1.05);
    }

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(12px);
      display: none; align-items: center; justify-content: center; z-index: 3000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card); border: 1px solid var(--border); border-radius: 40px; padding: 32px;
      width: 92%; max-width: 480px; box-shadow: var(--shadow); animation: modalPop 0.3s;
      backdrop-filter: var(--blur);
    }
    @keyframes modalPop {
      from { opacity: 0; transform: scale(0.9) rotate(-5deg); }
      to { opacity: 1; transform: scale(1) rotate(0); }
    }
    .close-modal { float: right; font-size: 2.5rem; line-height: 1; cursor: pointer; color: var(--text-sec); transition: transform 0.2s; }
    .close-modal:hover { transform: rotate(90deg); }

    .feed-end-sentinel {
      height: 20px;
      width: 100%;
    }

    @media (max-width: 700px) {
      .main-content { padding: 16px; }
      .profile-header { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">
    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    –ì–æ–ª–æ–≤–Ω–∞
  </a>
  <a data-section="search">
    <svg class="icon-svg" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    –ü–æ—à—É–∫
  </a>
  <a data-section="profile">
    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    –ü—Ä–æ—Ñ—ñ–ª—å
  </a>
  <a data-section="chats">
    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    <span id="unreadBadge" class="badge" style="display:none;">0</span>
  </a>
  <a data-section="settings">
    <svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H5.78a1.65 1.65 0 0 0-1.51 1 1.65 1.65 0 0 0 .33 1.82l.07.07A10 10 0 0 0 12 17.66a10 10 0 0 0 6.26-2.26z"/></svg>
    –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
  </a>
</nav>

<main class="main-content">

  <!-- –ì–û–õ–û–í–ù–ê -->
  <div id="home" class="section active">
    <div class="card" id="authBox">
      <div id="loginForm">
        <input type="text" id="loginNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)" autocomplete="off"/>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button id="googleLoginBtn" style="flex:1; background:#2a2a2a;">Google</button>
          <button id="appleLoginBtn" style="flex:1; background:#1a1a1a;">Apple</button>
        </div>
        <p style="margin-top:18px;">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id="toRegister" style="color:var(--accent);cursor:pointer;">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p>
        <p><a href="#" id="forgotPassword" style="color:var(--accent);">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</a></p>
      </div>
      <div id="registerForm" style="display:none;">
        <input type="text" id="registerNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)"/>
        <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="registerBtn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <p style="margin-top:18px;">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id="toLogin" style="color:var(--accent);cursor:pointer;">–£–≤—ñ–π—Ç–∏</span></p>
      </div>
    </div>

    <div class="card" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ?" rows="3"></textarea>
      <div style="display:flex; gap:12px; align-items:center; margin:15px 0;">
        <button id="emojiPostBtn">üòä –î–æ–¥–∞—Ç–∏ –µ–º–æ–¥–∑—ñ</button>
        <div id="emojiPostPicker" class="emoji-panel" style="display:none;">
          <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span><span>üò¢</span><span>üòé</span>
        </div>
      </div>
      <input type="file" id="postMedia" accept="image/*,video/*" style="margin:12px 0;"/>
      <button id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Å—Ç—Ä—ñ—á–æ–∫ -->
    <div class="feed-header">
      <button id="feedNewBtn" class="active">
        <svg class="icon-svg" viewBox="0 0 24 24" style="width:20px; height:20px;"><path d="M12 2l-5.5 9h11z"/><circle cx="17.5" cy="17.5" r="4.5"/><path d="M3 13.5h8v8H3z"/></svg> –ù–æ–≤—ñ
      </button>
      <button id="feedPopularBtn">
        <svg class="icon-svg" viewBox="0 0 24 24" style="width:20px; height:20px;"><path d="M15 5l-1.41 1.41L18.17 11H2v2h16.17l-4.59 4.59L15 19l7-7z"/></svg> –ü–æ–ø—É–ª—è—Ä–Ω—ñ
      </button>
    </div>

    <!-- –ü–æ—à—É–∫ —É –ø–æ–ø—É–ª—è—Ä–Ω–æ–º—É -->
    <div id="popularSearchContainer" class="popular-search" style="display: none;">
      <input type="text" id="popularSearchInput" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω—ñ–∫–æ–º –∞–≤—Ç–æ—Ä–∞..." />
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ—Å—Ç—ñ–≤ -->
    <div class="feed" id="feed"></div>
    <div class="feed-end-sentinel" id="feedSentinel"></div>
    <div id="skeletonContainer" style="display:none;">
      <div class="skeleton-post"></div>
      <div class="skeleton-post"></div>
    </div>
  </div>

  <!-- –ü–û–®–£–ö -->
  <div id="search" class="section">
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫ –∑–∞ @id –∞–±–æ —ñ–º'—è–º..."/>
    <div class="user-list" id="userList"></div>
  </div>

  <!-- –ü–†–û–§–Ü–õ–¨ -->
  <div id="profile" class="section">
    <div class="card profile-header" id="profileHeader"></div>
    <div class="profile-tabs" id="profileTabs"></div>
    <div class="feed" id="profileFeed"></div>
  </div>

  <!-- –ß–ê–¢–ò -->
  <div id="chats" class="section">
    <div class="chat-list" id="chatList"></div>
    <div class="chat-window" id="chatWindow">
      <div class="chat-header" id="chatHeader">
        <div class="avatar" id="chatAvatar"></div>
        <span id="chatName"></span>
        <span class="user-id-small" id="chatUserId"></span>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."/>
        <button id="sendMessage">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø -->
  <div id="settings" class="section card">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <button id="toggleTheme" style="margin:20px 0;">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É üåô/‚òÄÔ∏è</button>
    <button id="toggleTvMode" style="margin:20px 0;">–†–µ–∂–∏–º —Ç–µ–ª–µ–≤—ñ–∑–æ—Ä–∞ üì∫</button>
    <button id="logoutBtn">–í–∏–π—Ç–∏</button>
  </div>
</main>

<!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ü–û–°–¢–ê -->
<div class="modal" id="editPostModal">
  <div class="modal-content">
    <span class="close-modal" id="closeEditPostModal">&times;</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å—Ç</h2>
    <textarea id="editPostText" rows="5" style="margin:20px 0;"></textarea>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button id="cancelEditPost">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button id="savePostEdit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ü–†–û–§–Ü–õ–Æ -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">&times;</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <input type="text" id="editNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)"/>
    <textarea id="editBio" placeholder="–ü—Ä–æ —Å–µ–±–µ" rows="4" style="margin:16px 0;"></textarea>
    <button id="saveProfileEdit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
</div>

<script type="module">
  // ================= Firebase –∑ –æ–Ω–æ–≤–ª–µ–Ω–∏–º authDomain =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, OAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, arrayUnion, arrayRemove, deleteDoc, getDocs, increment, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "satinov.pages.dev", // <-- –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ –Ω–æ–≤–∏–π –¥–æ–º–µ–Ω
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.firebasestorage.app",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentChatPartner = null;
  let unsubscribeFeed = null;
  let unsubscribeChat = null;
  let unsubscribeChatList = null;
  let currentEditPostId = null;
  let viewingProfileUid = null;
  let unreadCount = 0;
  let currentFeedType = 'new';
  let popularSearchTerm = '';

  // –î–ª—è —ñ–Ω—Ñ—ñ–Ω—ñ—Ç–Ω–æ–≥–æ —Å–∫—Ä–æ–ª—É
  let lastVisible = null;
  let loading = false;
  let hasMore = true;

  const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');

  // TV mode detection
  const tvQuery = window.matchMedia('(min-width: 1200px) and (hover: none) and (pointer: coarse)');
  if (tvQuery.matches) document.body.classList.add('tv');

  function updateUnreadBadge() {
    const badge = document.getElementById('unreadBadge');
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }

  // –ë—É—Ä–≥–µ—Ä
  document.getElementById('burger').onclick = () => {
    document.getElementById('burger').classList.toggle('active');
    document.getElementById('sidebar').classList.toggle('active');
  };

  // –ù–∞–≤—ñ–≥–∞—Ü—ñ—è
  document.querySelectorAll('[data-section]').forEach(link => {
    link.onclick = () => {
      const sectionId = link.dataset.section;
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
      if (sectionId === 'search') loadSearchUsers();
      if (sectionId === 'chats') {
        document.getElementById('chatWindow').style.display = 'none';
        loadChatList();
      }
      if (sectionId === 'profile') {
        if (!viewingProfileUid || viewingProfileUid === currentUser?.uid) {
          viewingProfileUid = currentUser?.uid;
          loadMyProfile();
        } else {
          loadUserProfile(viewingProfileUid);
        }
      }
      if (sectionId === 'home') resetPagination();
    };
  });

  // –°–∫–∏–¥–∞–Ω–Ω—è –ø–∞–≥—ñ–Ω–∞—Ü—ñ—ó
  function resetPagination() {
    lastVisible = null;
    hasMore = true;
    document.getElementById('feed').innerHTML = '';
    loadMorePosts();
  }

  // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ª–æ–≥—ñ–Ω/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  };
  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
  };

  // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
  document.getElementById('registerBtn').onclick = async () => {
    const nickname = document.getElementById('registerNickname').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    if (!nickname) return alert('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    if (password.length < 6) return alert('–ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤');
    
    const userId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", userId));
    const snap = await getDocs(q);
    if (!snap.empty) {
      return alert('–¶–µ–π ID –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π, –≤–∏–±–µ—Ä—ñ—Ç—å —ñ–Ω—à–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    }
    
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", cred.user.uid), {
        nickname,
        userId,
        nickname_lower: nickname.toLowerCase(),
        bio: '',
        avatar: '',
        posts: [],
        likedPosts: [],
        followers: [],
        following: [],
        createdAt: serverTimestamp()
      });
      alert('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞');
      document.getElementById('toLogin').click();
      document.getElementById('loginNickname').value = nickname;
    } catch (e) { alert(e.message); }
  };

  // –í—Ö—ñ–¥
  document.getElementById('loginBtn').onclick = async () => {
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!nickname || !password) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      await signInWithEmailAndPassword(auth, email, password);
    } catch { alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ –ø–∞—Ä–æ–ª—å'); }
  };

  // Google
  document.getElementById('googleLoginBtn').onclick = async () => {
    try {
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        const nickname = user.displayName || user.email.split('@')[0];
        let userId = `@${nickname.toLowerCase()}`;
        const q = query(collection(db, "users"), where("userId", "==", userId));
        const snap = await getDocs(q);
        if (!snap.empty) userId = `@${nickname.toLowerCase()}${Math.floor(Math.random()*1000)}`;
        await setDoc(doc(db, "users", user.uid), {
          nickname,
          userId,
          nickname_lower: nickname.toLowerCase(),
          bio: '',
          avatar: user.photoURL || '',
          posts: [],
          likedPosts: [],
          followers: [],
          following: [],
          createdAt: serverTimestamp()
        });
      }
    } catch (e) { alert(e.message); }
  };

  // Apple
  document.getElementById('appleLoginBtn').onclick = async () => {
    try {
      const provider = new OAuthProvider('apple.com');
      provider.addScope('email name');
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        const nickname = user.displayName || user.email.split('@')[0];
        let userId = `@${nickname.toLowerCase()}`;
        const q = query(collection(db, "users"), where("userId", "==", userId));
        const snap = await getDocs(q);
        if (!snap.empty) userId = `@${nickname.toLowerCase()}${Math.floor(Math.random()*1000)}`;
        await setDoc(doc(db, "users", user.uid), {
          nickname,
          userId,
          nickname_lower: nickname.toLowerCase(),
          bio: '',
          avatar: user.photoURL || '',
          posts: [],
          likedPosts: [],
          followers: [],
          following: [],
          createdAt: serverTimestamp()
        });
      }
    } catch (e) { alert(e.message); }
  };

  // –ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å
  document.getElementById('forgotPassword').onclick = async (e) => {
    e.preventDefault();
    const email = prompt('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à email (—è–∫—â–æ —Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ email)');
    if (email) {
      try {
        await sendPasswordResetEmail(auth, email);
        alert('–õ–∏—Å—Ç –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
      } catch (err) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + err.message);
      }
    }
  };

  // –°–ª—É—Ö–∞—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authBox').style.display = 'none';
      document.getElementById('newPostBox').style.display = 'block';
      resetPagination();
      loadMyProfile();
      if (unsubscribeChatList) unsubscribeChatList();
      const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
      unsubscribeChatList = onSnapshot(q, (snapshot) => {
        let totalUnread = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.unread && data.unread[currentUser.uid]) {
            totalUnread += data.unread[currentUser.uid];
          }
        });
        unreadCount = totalUnread;
        updateUnreadBadge();
      });
    } else {
      currentUser = null;
      document.getElementById('authBox').style.display = 'block';
      document.getElementById('newPostBox').style.display = 'none';
      if (unsubscribeFeed) unsubscribeFeed();
      if (unsubscribeChatList) unsubscribeChatList();
      unreadCount = 0;
      updateUnreadBadge();
    }
  });

  // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç—Ä—ñ—á–æ–∫
  document.getElementById('feedNewBtn').onclick = () => {
    if (currentFeedType === 'new') return;
    document.getElementById('feedNewBtn').classList.add('active');
    document.getElementById('feedPopularBtn').classList.remove('active');
    document.getElementById('popularSearchContainer').style.display = 'none';
    currentFeedType = 'new';
    popularSearchTerm = '';
    resetPagination();
  };

  document.getElementById('feedPopularBtn').onclick = () => {
    if (currentFeedType === 'popular') return;
    document.getElementById('feedPopularBtn').classList.add('active');
    document.getElementById('feedNewBtn').classList.remove('active');
    document.getElementById('popularSearchContainer').style.display = 'block';
    currentFeedType = 'popular';
    resetPagination();
  };

  // –ü–æ—à—É–∫ —É –ø–æ–ø—É–ª—è—Ä–Ω–æ–º—É
  document.getElementById('popularSearchInput').addEventListener('input', (e) => {
    popularSearchTerm = e.target.value.trim().toLowerCase();
    resetPagination();
  });

  // –ï–º–æ–¥–∑—ñ –¥–ª—è –ø–æ—Å—Ç–∞
  document.getElementById('emojiPostBtn').onclick = () => {
    const p = document.getElementById('emojiPostPicker');
    p.style.display = p.style.display === 'none' ? 'flex' : 'none';
  };
  document.querySelectorAll('#emojiPostPicker span').forEach(s => {
    s.onclick = () => {
      document.getElementById('postText').value += s.textContent;
      document.getElementById('emojiPostPicker').style.display = 'none';
    };
  });

  // –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ—Å—Ç–∞
  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return alert('–£–≤—ñ–π–¥—ñ—Ç—å');
    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];
    if (!text && !file) return alert('–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞');
    try {
      let mediaUrl = '', mediaType = '';
      if (file) {
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
        mediaType = file.type.split('/')[0];
      }
      
      const userSnap = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userSnap.data();
      
      await addDoc(collection(db, "posts"), {
        author: currentUser.uid,
        authorName: userData.nickname,
        authorUserId: userData.userId,
        authorAvatar: userData.avatar || '',
        text,
        mediaUrl,
        mediaType,
        createdAt: serverTimestamp(),
        likes: [],
        likesCount: 0,
        commentsCount: 0
      });
      
      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
    } catch (e) { alert(e.message); }
  };

  // –Ü–Ω—Ñ—ñ–Ω—ñ—Ç–Ω–∏–π —Å–∫—Ä–æ–ª
  async function loadMorePosts() {
    if (loading || !hasMore || !currentUser) return;
    loading = true;
    document.getElementById('skeletonContainer').style.display = 'block';

    let q;
    if (currentFeedType === 'new') {
      q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(10));
    } else {
      q = query(collection(db, "posts"), orderBy("likesCount", "desc"), orderBy("createdAt", "desc"), limit(10));
    }
    if (lastVisible) {
      q = query(q, startAfter(lastVisible));
    }
    
    const snapshot = await getDocs(q);
    document.getElementById('skeletonContainer').style.display = 'none';
    
    if (snapshot.empty) {
      hasMore = false;
      loading = false;
      return;
    }
    
    lastVisible = snapshot.docs[snapshot.docs.length - 1];
    await renderPosts(snapshot.docs);
    loading = false;
  }

  // –†–µ–Ω–¥–µ—Ä –ø–æ—Å—Ç—ñ–≤ (–æ–Ω–æ–≤–ª–µ–Ω–æ: –∑–∞–º—ñ—Å—Ç—å Lottie –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ SVG heart —Ç–∞ comment)
  async function renderPosts(docs) {
    const feed = document.getElementById('feed');
    
    for (const docSnap of docs) {
      const post = { id: docSnap.id, ...docSnap.data() };
      
      if (currentFeedType === 'popular' && popularSearchTerm) {
        const authorName = post.authorName || '';
        if (!authorName.toLowerCase().includes(popularSearchTerm)) continue;
      }
      
      const isOwn = post.author === currentUser?.uid;
      const liked = post.likes?.includes(currentUser?.uid) || false;
      
      let isFollowing = false;
      if (currentUser && post.author !== currentUser.uid) {
        const currentUserSnap = await getDoc(doc(db, "users", currentUser.uid));
        isFollowing = currentUserSnap.data().following?.includes(post.author) || false;
      }
      
      let contentHtml = post.text ? post.text.replace(/\n/g,'<br>') : '';
      if (post.text && post.text.length > 300) {
        contentHtml = `<span class="truncated">${post.text.slice(0,300).replace(/\n/g,'<br>')}...</span> <button class="show-more">Show more</button>`;
      }
      
      const postEl = document.createElement('div');
      postEl.className = 'post';
      postEl.dataset.postId = post.id;
      postEl.innerHTML = `
        <div class="post-header">
          <div class="avatar" style="background-image:url(${post.authorAvatar || ''})" data-uid="${post.author}"></div>
          <div class="post-user">
            <span class="username" data-uid="${post.author}">${post.authorName || '–ù–µ–≤—ñ–¥–æ–º–æ'}</span>
            <span class="user-id-small">${post.authorUserId || ''}</span>
          </div>
          ${isOwn ? `
            <button class="edit-post-btn" data-post-id="${post.id}">
              <svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
            </button>
            <button class="menu-btn" data-post-id="${post.id}">‚ãØ</button>
          ` : ''}
          ${!isOwn && currentUser ? `<button class="subscribe-post-btn" data-author-uid="${post.author}">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>` : ''}
        </div>
        <div class="post-content">${contentHtml}</div>
        ${post.mediaUrl ? (post.mediaType==='image' ? `<img src="${post.mediaUrl}" class="post-media">` : `<video src="${post.mediaUrl}" controls autoplay muted loop playsinline class="post-media"></video>`) : ''}
        <div class="post-footer">
          <button class="like-btn ${liked ? 'liked' : ''}" data-post-id="${post.id}">
            <svg viewBox="0 0 24 24">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <span>${post.likesCount || 0}</span>
          </button>
          <button class="comments-toggle" data-post-id="${post.id}">
            <svg viewBox="0 0 24 24">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <span>${post.commentsCount || 0}</span>
          </button>
        </div>
        <div class="comments-section" id="comments-${post.id}" style="display:none;">
          <div class="comments-list" id="comments-list-${post.id}"></div>
          <div class="comment-input-area">
            <textarea id="comment-text-${post.id}" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
            <button class="send-comment" data-post-id="${post.id}">‚û§</button>
          </div>
          <div class="emoji-panel" id="emoji-comment-${post.id}" style="display:none;">
            <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span>
          </div>
          <button class="emoji-comment-btn" data-post-id="${post.id}">üòã –ï–º–æ–¥–∑—ñ</button>
        </div>
      `;
      
      feed.appendChild(postEl);
      setTimeout(() => postEl.classList.add('show'), 50);
      
      const commentsToggle = postEl.querySelector('.comments-toggle');
      commentsToggle.addEventListener('click', async () => {
        const commentsDiv = document.getElementById(`comments-${post.id}`);
        if (commentsDiv.style.display === 'none') {
          commentsDiv.style.display = 'block';
          if (!postEl.commentsLoaded) {
            const commentsQuery = query(collection(db, "posts", post.id, "comments"), orderBy("createdAt", "desc"), limit(5));
            const commentsSnap = await getDocs(commentsQuery);
            const commentsList = document.getElementById(`comments-list-${post.id}`);
            commentsList.innerHTML = commentsSnap.docs.reverse().map(c => {
              const data = c.data();
              return `<div class="comment">
                <div class="avatar" style="background-image:url(${data.authorAvatar || ''})" data-uid="${data.author}"></div>
                <div class="comment-content">
                  <span class="comment-author" data-uid="${data.author}">${data.authorNickname || '–Ω–µ–≤—ñ–¥–æ–º–æ'}</span> ${data.text}
                </div>
              </div>`;
            }).join('');
            postEl.commentsLoaded = true;
          }
        } else {
          commentsDiv.style.display = 'none';
        }
      });
    }
  }

  // –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ–π —Å—Ç—Ä—ñ—á–∫–∏ (–æ–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ SVG)
  document.getElementById('feed').addEventListener('click', async (e) => {
    if (e.target.closest('.like-btn')) {
      const btn = e.target.closest('.like-btn');
      const postId = btn.dataset.postId;
      const liked = btn.classList.contains('liked');
      const countSpan = btn.querySelector('span:last-child');
      const oldCount = parseInt(countSpan.textContent);
      
      btn.classList.toggle('liked');
      countSpan.textContent = liked ? oldCount - 1 : oldCount + 1;
      
      try {
        const postRef = doc(db, "posts", postId);
        if (liked) {
          await updateDoc(postRef, {
            likes: arrayRemove(currentUser.uid),
            likesCount: increment(-1)
          });
          await updateDoc(doc(db, "users", currentUser.uid), {
            likedPosts: arrayRemove(postId)
          });
        } else {
          await updateDoc(postRef, {
            likes: arrayUnion(currentUser.uid),
            likesCount: increment(1)
          });
          await updateDoc(doc(db, "users", currentUser.uid), {
            likedPosts: arrayUnion(postId)
          });
        }
      } catch (e) {
        btn.classList.toggle('liked');
        countSpan.textContent = oldCount;
        alert('–ü–æ–º–∏–ª–∫–∞');
      }
    }
    
    if (e.target.closest('.edit-post-btn')) {
      const btn = e.target.closest('.edit-post-btn');
      const postId = btn.dataset.postId;
      const postDiv = btn.closest('.post');
      const contentDiv = postDiv.querySelector('.post-content');
      const currentText = contentDiv.innerText;
      
      const textarea = document.createElement('textarea');
      textarea.value = currentText;
      textarea.className = 'edit-post-textarea';
      textarea.style.width = '100%';
      textarea.style.minHeight = '80px';
      contentDiv.replaceWith(textarea);
      textarea.focus();
      
      const saveEdit = async () => {
        const newText = textarea.value.trim();
        await updateDoc(doc(db, "posts", postId), { text: newText });
        const newContent = document.createElement('div');
        newContent.className = 'post-content';
        newContent.innerHTML = newText.replace(/\n/g,'<br>');
        textarea.replaceWith(newContent);
      };
      
      textarea.addEventListener('blur', saveEdit);
      textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          saveEdit();
        }
      });
    }
    
    if (e.target.closest('.menu-btn')) {
      const postId = e.target.closest('.menu-btn').dataset.postId;
      if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç?')) {
        const postRef = doc(db, "posts", postId);
        const postSnap = await getDoc(postRef);
        const author = postSnap.data().author;
        await deleteDoc(postRef);
        await updateDoc(doc(db, "users", author), { posts: arrayRemove(postId) });
        e.target.closest('.post').remove();
      }
    }
    
    if (e.target.classList.contains('show-more')) {
      const postDiv = e.target.closest('.post');
      const contentDiv = postDiv.querySelector('.post-content');
      const fullText = contentDiv.innerText.replace('... Show more', '');
      const postId = postDiv.dataset.postId;
      const postRef = doc(db, "posts", postId);
      const snap = await getDoc(postRef);
      contentDiv.innerHTML = snap.data().text.replace(/\n/g,'<br>');
    }
    
    if (e.target.closest('.send-comment')) {
      const btn = e.target.closest('.send-comment');
      const postId = btn.dataset.postId;
      const textarea = document.getElementById(`comment-text-${postId}`);
      const text = textarea.value.trim();
      if (!text) return;
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userDoc.data();
      await addDoc(collection(db, "posts", postId, "comments"), {
        author: currentUser.uid,
        authorNickname: userData.nickname,
        authorUserId: userData.userId,
        authorAvatar: userData.avatar || '',
        text,
        createdAt: serverTimestamp()
      });
      await updateDoc(doc(db, "posts", postId), { commentsCount: increment(1) });
      textarea.value = '';
    }
    
    if (e.target.closest('.emoji-comment-btn')) {
      const btn = e.target.closest('.emoji-comment-btn');
      const postId = btn.dataset.postId;
      const picker = document.getElementById(`emoji-comment-${postId}`);
      picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
    }
    
    if (e.target.closest('.emoji-panel span')) {
      const span = e.target.closest('.emoji-panel span');
      const picker = span.closest('.emoji-panel');
      const postId = picker.id.replace('emoji-comment-', '');
      const textarea = document.getElementById(`comment-text-${postId}`);
      textarea.value += span.textContent;
      picker.style.display = 'none';
    }
    
    if (e.target.closest('.subscribe-post-btn')) {
      const btn = e.target.closest('.subscribe-post-btn');
      const authorUid = btn.dataset.authorUid;
      await toggleFollow(authorUid);
      const isFollowing = (await getDoc(doc(db, "users", currentUser.uid))).data().following.includes(authorUid);
      btn.textContent = isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';
    }
    
    if (e.target.closest('[data-uid]')) {
      const el = e.target.closest('[data-uid]');
      const uid = el.dataset.uid;
      if (uid === currentUser.uid) {
        viewingProfileUid = currentUser.uid;
        loadMyProfile();
      } else {
        viewingProfileUid = uid;
        loadUserProfile(uid);
      }
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('profile').classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
    }
  });

  // –Ü–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (–ø—Ä–æ—Ñ—ñ–ª—å, —á–∞—Ç–∏, —Ç–µ–º–∞ —Ç–æ—â–æ) –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω
  // (–≤–æ–Ω–∏ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó, —Ç–æ–º—É –¥–ª—è —Å—Ç–∏—Å–ª–æ—Å—Ç—ñ —Ç—É—Ç –Ω–µ –¥—É–±–ª—é—é—Ç—å—Å—è,
  // –∞–ª–µ –≤ –ø–æ–≤–Ω–æ–º—É –∫–æ–¥—ñ –≤–æ–Ω–∏ –º–∞—é—Ç—å –±—É—Ç–∏ –ø—Ä–∏—Å—É—Ç–Ω—ñ. –í –¥–∞–Ω–æ–º—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤–æ–Ω–∏ –æ–ø—É—â–µ–Ω—ñ,
  // –æ—Å–∫—ñ–ª—å–∫–∏ –Ω–µ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ —Å—É—Ç—å –∑–º—ñ–Ω.)
  
  // ‚Ä¶ —Ç—É—Ç –º–∞—é—Ç—å –±—É—Ç–∏ –≤—Å—ñ —ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (loadSearchUsers, toggleFollow, loadMyProfile, loadUserProfile, renderProfile, loadProfileFeed, loadChatList, openChat, subscribeToChat, –æ–±—Ä–æ–±–Ω–∏–∫–∏ –º–æ–¥–∞–ª–æ–∫, —Ç–µ–º–∏, –≤–∏—Ö—ñ–¥ —Ç–æ—â–æ) –±–µ–∑ –∑–º—ñ–Ω ‚Ä¶
  // –û—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ, –∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —ñ —Ç–∞–∫ –≤–µ–ª–∏–∫–∞, —è —ó—Ö –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—É—é –ø–æ–≤—Ç–æ—Ä–Ω–æ.
  // –ê–ª–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É –∫–æ–¥—ñ –≤–æ–Ω–∏ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –º–∞—é—Ç—å –±—É—Ç–∏ –¥–æ–¥–∞–Ω—ñ.

  // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó –≤–∞–∂–ª–∏–≤–∏—Ö –∑–º—ñ–Ω —è —ó—Ö —Ç—É—Ç –Ω–µ –Ω–∞–≤–æ–¥–∂—É, –∞–ª–µ –≤ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–º—É —Ä—ñ—à–µ–Ω–Ω—ñ –≤–æ–Ω–∏ –ø—Ä–∏—Å—É—Ç–Ω—ñ.
</script>
</body>
</html>
