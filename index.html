<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FANTASYAS</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg-primary: #000;
      --text-primary: #fff;
      --bg-secondary: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.1);
      --accent-gradient: linear-gradient(90deg, #fff, #aaa);
      --text-secondary: #aaa;
      --blur: blur(10px);
      --transition: all 0.3s ease;
    }

    body.light {
      --bg-primary: #f8f9fa;
      --text-primary: #111;
      --bg-secondary: rgba(0,0,0,0.03);
      --border: rgba(0,0,0,0.08);
      --accent-gradient: linear-gradient(90deg, #000, #444);
      --text-secondary: #555;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Manrope', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.4s, color 0.4s;
    }

    body.large-font { font-size: 1.12rem; }

    /* –¢–æ–ø-–±–∞—Ä */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: rgba(0,0,0,0.4);
      backdrop-filter: var(--blur);
      border-bottom: 1px solid var(--border);
      z-index: 1000;
      transition: var(--transition);
    }

    body.light .top-bar {
      background: rgba(255,255,255,0.7);
    }

    .site-name {
      font-size: 1.8rem;
      font-weight: 800;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* –ë—É—Ä–≥–µ—Ä */
    .burger {
      position: relative;
      width: 32px;
      height: 24px;
      cursor: pointer;
      transition: var(--transition);
    }

    .burger span {
      position: absolute;
      width: 100%;
      height: 3px;
      background: var(--text-primary);
      border-radius: 2px;
      transition: all 0.35s cubic-bezier(0.65, -0.15, 0.35, 1.35);
    }

    .burger span:nth-child(1) { top: 0; }
    .burger span:nth-child(2) { top: 10px; }
    .burger span:nth-child(3) { top: 20px; }

    .burger.active span:nth-child(1) { transform: rotate(45deg) translate(8px, 8px); }
    .burger.active span:nth-child(2) { opacity: 0; transform: translateX(-20px); }
    .burger.active span:nth-child(3) { transform: rotate(-45deg) translate(7px, -7px); }

    /* –°–∞–π–¥–±–∞—Ä (–ª—ñ–≤–µ –º–µ–Ω—é) */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100%;
      background: rgba(0,0,0,0.92);
      backdrop-filter: blur(16px) saturate(180%);
      border-right: 1px solid var(--border);
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
      padding: 120px 32px 32px;
      z-index: 950;
      overflow-y: auto;
    }

    body.light .sidebar {
      background: rgba(255,255,255,0.92);
    }

    .sidebar.active { transform: translateX(0); }

    .sidebar a {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-secondary);
      font-size: 1.28rem;
      font-weight: 600;
      padding: 14px 16px;
      border-radius: 12px;
      margin: 8px 0;
      transition: var(--transition);
      text-decoration: none;
      cursor: pointer;
    }

    .sidebar a:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding-left: 24px;
      transform: translateX(6px);
    }

    /* –ë–µ–∫–¥—Ä–æ–ø –¥–ª—è –º–µ–Ω—é */
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 800;
    }

    .backdrop.active {
      opacity: 1;
      pointer-events: all;
    }

    /* –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .main-content {
      margin-top: 100px;
      padding: 20px 25px;
      transition: var(--transition);
    }

    .section { display: none; padding: 0 8px; }
    .section.active { display: block; animation: fadeIn 0.5s ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* –§–æ—Ä–º–∏ —Ç–∞ –±–æ–∫—Å–∏ */
    .login-box, .new-post, .settings, .profile-edit-form {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      transition: var(--transition);
      animation: scaleIn 0.4s ease;
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    input, textarea {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      outline: none;
      font-family: 'Manrope', sans-serif;
      resize: vertical;
      transition: var(--transition);
    }

    input::placeholder, textarea::placeholder { color: var(--text-secondary); }

    button {
      width: fit-content;
      padding: 10px 18px;
      border: none;
      border-radius: 12px;
      background: var(--text-primary);
      color: var(--bg-primary);
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
    }

    button:hover { opacity: 0.9; transform: scale(1.05); }

    .danger-btn { background: #c53030 !important; color: #fff !important; }
    .danger-btn:hover { background: #a71d2a !important; }

    /* –§—ñ–¥ –ø–æ—Å—Ç—ñ–≤ */
    .feed { display: flex; flex-direction: column; gap: 20px; }

    .post {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      transition: var(--transition);
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .post:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }

    .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }

    .avatar {
      width: 48px;
      height: 48px;
      background: #444;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      transition: var(--transition);
    }

    body.light .avatar { background: #ccc; }

    .username { font-weight: 700; font-size: 1.05rem; }

    .post-content { font-size: 0.95rem; line-height: 1.5; margin-bottom: 12px; }

    .post-meta { color: var(--text-secondary); font-size: 0.8rem; margin-top: 4px; }

    .post-footer { display: flex; gap: 20px; margin-top: 12px; }

    .post-footer button {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
    }

    .post-footer button:hover { color: var(--text-primary); transform: scale(1.1); }

    /* –†–µ–∞–∫—Ü—ñ—ó –µ–º–æ–¥–∑—ñ */
    .reactions-container {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      user-select: none;
    }

    .emoji-btn {
      font-size: 1.4rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--bg-secondary);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .emoji-btn:hover {
      transform: scale(1.15);
    }

    .emoji-pop {
      position: absolute;
      inset: 0;
      pointer-events: none;
      font-size: 2.2rem;
      opacity: 0;
      transform: translateY(0) scale(0.3);
      animation: popFly 0.9s forwards cubic-bezier(0.22, 0.61, 0.36, 1);
    }

    @keyframes popFly {
      0%   { opacity: 0; transform: translateY(0) scale(0.4); }
      20%  { opacity: 1; transform: translateY(-10px) scale(1.3); }
      50%  { opacity: 1; transform: translateY(-60px) scale(1.6); }
      80%  { opacity: 0.7; transform: translateY(-120px) scale(1.2); }
      100% { opacity: 0; transform: translateY(-180px) scale(0.6); }
    }

    /* –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ */
    .comments-section {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .comment {
      font-size: 0.9rem;
      margin: 8px 0;
      padding-left: 12px;
      border-left: 3px solid #555;
    }

    body.light .comment { border-left: 3px solid #aaa; }

    .comment strong { color: #ddd; }
    body.light .comment strong { color: #333; }

    .comment-input { display: flex; gap: 10px; margin-top: 12px; }
    .comment-input input { flex: 1; }

    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: var(--transition);
    }

    .modal.active { display: flex; }

    .modal-content {
      background: #111;
      width: 90%;
      max-width: 500px;
      border-radius: 16px;
      padding: 28px;
      position: relative;
      border: 1px solid var(--border);
      animation: scaleIn 0.4s ease;
    }

    body.light .modal-content { background: #fff; color: #000; }

    .close-modal {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--text-secondary);
    }

    /* –ü—Ä–æ—Ñ—ñ–ª—å */
    .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #333;
      background-size: cover;
      transition: var(--transition);
    }

    body.light .profile-avatar { background: #ddd; }

    .profile-info h2 { font-size: 2rem; }

    .profile-bio { color: var(--text-secondary); margin: 12px 0; line-height: 1.6; }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      margin: 30px 0;
    }

    .stat-card {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .stat-card:hover { transform: scale(1.05); }

    .stat-number { font-size: 2.2rem; font-weight: 800; }
    .stat-label { color: var(--text-secondary); font-size: 0.95rem; }

    @media (max-width: 900px) {
      .sidebar { width: 100%; transform: translateX(-100%); padding: 100px 20px; border-right: none; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">–ì–æ–ª–æ–≤–Ω–∞</a>
  <a data-section="profile">–ü—Ä–æ—Ñ—ñ–ª—å</a>
  <a data-section="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a>
  <a href="#">–ü—Ä–æ –Ω–∞—Å</a>
  <a href="#">–ü–æ—Å–ª—É–≥–∏</a>
  <a href="#">–ü–æ—Ä—Ç—Ñ–æ–ª—ñ–æ</a>
  <a href="#">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a>
</nav>

<div class="backdrop" id="backdrop"></div>

<main class="main-content">

  <!-- –ì–æ–ª–æ–≤–Ω–∞ -->
  <div id="home" class="section active">
    <div class="login-box" id="loginBox">
      <input type="text" id="usernameInput" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å–≤–æ—î —ñ–º'—è">
      <button id="saveUsername">–ü–æ—á–∞—Ç–∏</button>
    </div>

    <div class="new-post" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="–©–æ —É —Ç–µ–±–µ –Ω–∞ –¥—É–º—Ü—ñ?..." rows="4"></textarea>
      <button id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <div class="feed" id="feed"></div>
  </div>

  <!-- –ü—Ä–æ—Ñ—ñ–ª—å -->
  <div id="profile" class="section">
    <div class="profile-header">
      <div class="profile-avatar" id="profileAvatar"></div>
      <div class="profile-info">
        <h2 id="profileUsernameDisplay"></h2>
        <p class="profile-meta">–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ: <span id="registerDate"></span></p>
      </div>
      <button id="editProfileBtn">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
    </div>

    <p class="profile-bio" id="profileBio">–ù–µ–º–∞—î –æ–ø–∏—Å—É...</p>

    <div class="profile-stats">
      <div class="stat-card"><div class="stat-number" id="postCount">0</div><div class="stat-label">–ø–æ—Å—Ç—ñ–≤</div></div>
      <div class="stat-card"><div class="stat-number" id="likeCount">0</div><div class="stat-label">–ª–∞–π–∫—ñ–≤ –æ—Ç—Ä–∏–º–∞–Ω–æ</div></div>
      <div class="stat-card"><div class="stat-number" id="commentCount">0</div><div class="stat-label">–∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤</div></div>
      <div class="stat-card"><div class="stat-number" id="favoriteCount">0</div><div class="stat-label">–≤ –æ–±—Ä–∞–Ω–æ–º—É</div></div>
    </div>

    <h3 style="margin:40px 0 20px;">–¢–≤–æ—ó –ø–æ—Å—Ç–∏</h3>
    <div id="profilePosts" class="feed"></div>
  </div>

  <!-- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è -->
  <div id="settings" class="section">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <div class="settings">
      <label>–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
      <input type="text" id="changeUsername" placeholder="–ù–æ–≤–µ —ñ–º'—è">

      <label>–ê–≤–∞—Ç–∞—Ä (–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ —Ñ–∞–π–ª—É)</label>
      <input type="file" id="avatarFileInput" accept="image/*">

      <label>–ê–±–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∞–≤–∞—Ç–∞—Ä (URL)</label>
      <input type="url" id="changeAvatar" placeholder="https://example.com/avatar.jpg">

      <label>–ü—Ä–æ —Å–µ–±–µ / –±—ñ–æ</label>
      <textarea id="changeBio" placeholder="–†–æ–∑–∫–∞–∂–∏ –ø—Ä–æ —Å–µ–±–µ..." rows="4"></textarea>

      <div style="margin:20px 0;">
        <label>–¢–µ–º–∞:</label><br>
        <select id="themeSelect">
          <option value="dark">–¢–µ–º–Ω–∞ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)</option>
          <option value="light">–°–≤—ñ—Ç–ª–∞</option>
        </select>
      </div>

      <div style="margin:20px 0;">
        <label>–†–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç—É:</label><br>
        <select id="fontSizeSelect">
          <option value="normal">–ó–≤–∏—á–∞–π–Ω–∏–π</option>
          <option value="large">–í–µ–ª–∏–∫–∏–π</option>
        </select>
      </div>

      <button id="saveSettings">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>

      <hr style="margin:40px 0; border-color:var(--border);">

      <button class="danger-btn" id="logoutBtn">–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</button>
      <button class="danger-btn" id="deleteAccountBtn">–í–∏–¥–∞–ª–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</button>
      <button class="danger-btn" id="clearAllData">–û—á–∏—Å—Ç–∏—Ç–∏ –í–°–Ü –¥–∞–Ω—ñ —Å–∞–π—Ç—É</button>
    </div>
  </div>

</main>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">√ó</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <div class="profile-edit-form">
      <label>–ê–≤–∞—Ç–∞—Ä (–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ —Ñ–∞–π–ª—É)</label>
      <input type="file" id="editAvatarFile" accept="image/*">

      <label>–ê–±–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∞–≤–∞—Ç–∞—Ä (URL)</label>
      <input type="url" id="editAvatar" placeholder="https://...">

      <label>–ë—ñ–æ</label>
      <textarea id="editBio" rows="5"></textarea>

      <button id="saveProfileEdit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>
</div>

<script>
const KEY = {
  USERNAME: 'fantasyasUsername',
  USER: 'fantasyasUserData',
  POSTS: 'fantasyas_posts_v4'
};

let username = localStorage.getItem(KEY.USERNAME);
let userData = JSON.parse(localStorage.getItem(KEY.USER)) || {
  avatar: '',
  bio: '',
  registered: new Date().toISOString().split('T')[0],
  favorites: []
};
let posts = JSON.parse(localStorage.getItem(KEY.POSTS)) || [];

const burger = document.getElementById('burger');
const sidebar = document.getElementById('sidebar');
const backdrop = document.getElementById('backdrop');
const sections = document.querySelectorAll('.section');
const loginBox = document.getElementById('loginBox');
const newPostBox = document.getElementById('newPostBox');
const feed = document.getElementById('feed');
const postText = document.getElementById('postText');
const modal = document.getElementById('editProfileModal');

// –ë—É—Ä–≥–µ—Ä —Ç–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è
burger.addEventListener('click', () => {
  burger.classList.toggle('active');
  sidebar.classList.toggle('active');
  backdrop.classList.toggle('active');
});

backdrop.addEventListener('click', () => {
  burger.classList.remove('active');
  sidebar.classList.remove('active');
  backdrop.classList.remove('active');
});

function showSection(id) {
  sections.forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  sidebar.classList.remove('active');
  burger.classList.remove('active');
  backdrop.classList.remove('active');
  if (id === 'profile') updateProfile();
}

document.querySelectorAll('[data-section]').forEach(el => {
  el.addEventListener('click', () => showSection(el.dataset.section));
});

// –¢–µ–º–∞ —Ç–∞ —à—Ä–∏—Ñ—Ç
function applyPreferences() {
  const theme = localStorage.getItem('fantasyasTheme') || 'dark';
  const font = localStorage.getItem('fantasyasFontSize') || 'normal';
  document.body.classList.toggle('light', theme === 'light');
  document.body.classList.toggle('large-font', font === 'large');
  document.getElementById('themeSelect').value = theme;
  document.getElementById('fontSizeSelect').value = font;
}

applyPreferences();

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
if (username) {
  loginBox.style.display = 'none';
  newPostBox.style.display = 'flex';
  applyPreferences();
} else {
  newPostBox.style.display = 'none';
}

document.getElementById('saveUsername').addEventListener('click', () => {
  const val = document.getElementById('usernameInput').value.trim();
  if (!val) return alert('–í–≤–µ–¥–∏ —ñ–º‚Äô—è');
  username = val;
  localStorage.setItem(KEY.USERNAME, username);
  if (!userData.registered) userData.registered = new Date().toISOString().split('T')[0];
  localStorage.setItem(KEY.USER, JSON.stringify(userData));
  loginBox.style.display = 'none';
  newPostBox.style.display = 'flex';
  renderPosts();
});

// –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ—Å—Ç–∞
document.getElementById('addPost').addEventListener('click', () => {
  const text = postText.value.trim();
  if (!text || !username) return;
  posts.unshift({
    id: Date.now(),
    username,
    text,
    likes: 0,
    likedBy: [],
    comments: [],
    reactions: { "‚ù§Ô∏è":0, "üî•":0, "üòÇ":0, "üòÆ":0 },
    created: new Date().toISOString()
  });
  savePosts();
  postText.value = '';
  renderPosts();
});

// –û–±—Ä–æ–±–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏
function handleAvatarUpload(inputEl, isModal = false) {
  inputEl.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 2 * 1024 * 1024) {
      alert('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ (–º–∞–∫—Å–∏–º—É–º ~2 –ú–ë)');
      e.target.value = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = ev => {
      userData.avatar = ev.target.result;
      localStorage.setItem(KEY.USER, JSON.stringify(userData));
      updateProfile();
      renderPosts();
      if (isModal) modal.classList.remove('active');
      alert('–ê–≤–∞—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ!');
      e.target.value = '';
    };
    reader.readAsDataURL(file);
  });
}

handleAvatarUpload(document.getElementById('avatarFileInput'));
handleAvatarUpload(document.getElementById('editAvatarFile'), true);

// –†–µ–Ω–¥–µ—Ä –ø–æ—Å—Ç—ñ–≤
function renderPosts(container = feed, onlyUser = false) {
  container.innerHTML = '';
  posts.filter(p => !onlyUser || p.username === username).forEach(post => {
    const isLiked = post.likedBy?.includes(username);
    const isFavorite = userData.favorites?.includes(post.id);

    const postEl = document.createElement('div');
    postEl.className = 'post';
    postEl.innerHTML = `
      <div class="post-header">
        <div class="avatar" style="background-image:url('${getAvatar(post.username)}')"></div>
        <div class="username">${post.username}</div>
      </div>
      <div class="post-content" id="content-${post.id}">${post.text.replace(/\n/g, '<br>')}</div>
      <div class="post-meta">${new Date(post.created).toLocaleString('uk-UA', {dateStyle:'short', timeStyle:'short'})}</div>
      <div class="post-footer">
        <button class="like-btn ${isLiked ? 'liked' : ''}">‚ù§Ô∏è ${post.likes || 0}</button>
        <button class="comment-btn">ü´∂ ${post.comments?.length || 0}</button>
        <button class="favorite-btn ${isFavorite ? 'favorited' : ''}">ü§©</button>
        ${post.username === username ? '<button class="edit-btn">üò≠</button>' : ''}
      </div>
      <div class="reactions-container">
        ${Object.keys(post.reactions).map(e => `
          <span class="emoji-btn" data-e="${e}">
            ${e} <span class="count">${post.reactions[e]}</span>
          </span>
        `).join('')}
      </div>
      <div class="comments-section" id="comments-${post.id}"></div>
      <div class="comment-input">
        <input type="text" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä..." class="comment-inp"/>
        <button class="add-comment-btn">‚Üí</button>
      </div>
    `;

    // –õ–∞–π–∫
    postEl.querySelector('.like-btn').addEventListener('click', () => {
      if (!username) return alert('–£–≤—ñ–π–¥–∏');
      if (!post.likedBy) post.likedBy = [];
      const idx = post.likedBy.indexOf(username);
      if (idx === -1) {
        post.likedBy.push(username);
        post.likes = (post.likes || 0) + 1;
      } else {
        post.likedBy.splice(idx, 1);
        post.likes--;
      }
      savePosts();
      renderPosts(container, onlyUser);
      if (container !== feed) updateProfile();
    });

    // –§–∞–≤–æ—Ä–∏—Ç
    postEl.querySelector('.favorite-btn').addEventListener('click', () => {
      if (!username) return alert('–£–≤—ñ–π–¥–∏');
      if (!userData.favorites) userData.favorites = [];
      const idx = userData.favorites.indexOf(post.id);
      if (idx === -1) {
        userData.favorites.push(post.id);
      } else {
        userData.favorites.splice(idx, 1);
      }
      localStorage.setItem(KEY.USER, JSON.stringify(userData));
      renderPosts(container, onlyUser);
      if (container !== feed) updateProfile();
    });

    // –†–µ–∞–∫—Ü—ñ—ó –µ–º–æ–¥–∑—ñ
    postEl.querySelectorAll('.emoji-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const emoji = btn.dataset.e;
        post.reactions[emoji]++;
        savePosts();

        const pop = document.createElement('span');
        pop.className = 'emoji-pop';
        pop.textContent = emoji;
        btn.appendChild(pop);
        pop.addEventListener('animationend', () => pop.remove());

        renderPosts(container, onlyUser);
      });
    });

    // –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ
    const inp = postEl.querySelector('.comment-inp');
    const btn = postEl.querySelector('.add-comment-btn');
    btn.addEventListener('click', () => {
      const text = inp.value.trim();
      if (!text || !username) return;
      if (!post.comments) post.comments = [];
      post.comments.push({user: username, text, time: Date.now()});
      inp.value = '';
      savePosts();
      renderComments(post.id, postEl.querySelector(`#comments-${post.id}`));
      renderPosts(container, onlyUser);
    });

    // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–æ—Å—Ç–∞
    if (post.username === username) {
      postEl.querySelector('.edit-btn').addEventListener('click', () => {
        const contentDiv = document.getElementById(`content-${post.id}`);
        const textarea = document.createElement('textarea');
        textarea.value = post.text;
        textarea.style.width = '100%';
        textarea.style.marginTop = '10px';

        const saveBtn = document.createElement('button');
        saveBtn.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏';
        saveBtn.style.marginTop = '8px';

        contentDiv.replaceWith(textarea);
        textarea.after(saveBtn);

        saveBtn.addEventListener('click', () => {
          post.text = textarea.value.trim();
          savePosts();
          renderPosts(container, onlyUser);
        });
      });
    }

    renderComments(post.id, postEl.querySelector(`#comments-${post.id}`));
    container.appendChild(postEl);
  });
}

function renderComments(postId, container) {
  container.innerHTML = '';
  const post = posts.find(p => p.id === postId);
  (post?.comments || []).forEach(c => {
    const div = document.createElement('div');
    div.className = 'comment';
    div.innerHTML = `<strong>${c.user}</strong>: ${c.text}`;
    container.appendChild(div);
  });
}

function getAvatar(uname) {
  if (uname === username) return userData.avatar || '';
  return '';
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
function updateProfile() {
  if (!username) return;

  document.getElementById('profileUsernameDisplay').textContent = username;
  document.getElementById('registerDate').textContent = userData.registered || '–Ω–µ–≤—ñ–¥–æ–º–æ';
  document.getElementById('profileBio').textContent = userData.bio || '–ù–µ–º–∞—î –æ–ø–∏—Å—É...';

  const avatarEl = document.getElementById('profileAvatar');
  avatarEl.style.backgroundImage = userData.avatar ? `url('${userData.avatar}')` : '';

  let postCount = 0, likeCount = 0, commentCount = 0;
  posts.forEach(p => {
    if (p.username === username) {
      postCount++;
      likeCount += p.likes || 0;
      commentCount += p.comments?.length || 0;
    }
  });

  document.getElementById('postCount').textContent = postCount;
  document.getElementById('likeCount').textContent = likeCount;
  document.getElementById('commentCount').textContent = commentCount;
  document.getElementById('favoriteCount').textContent = userData.favorites?.length || 0;

  renderPosts(document.getElementById('profilePosts'), true);
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
document.getElementById('saveSettings').addEventListener('click', () => {
  const newName = document.getElementById('changeUsername').value.trim();
  const newAvatarUrl = document.getElementById('changeAvatar').value.trim();
  const newBio = document.getElementById('changeBio').value.trim();

  if (newName && newName !== username) {
    if (!confirm(`–ó–º—ñ–Ω–∏—Ç–∏ —ñ–º'—è –Ω–∞ "${newName}"?`)) return;
    posts.forEach(p => {
      if (p.username === username) p.username = newName;
      p.comments?.forEach(c => { if (c.user === username) c.user = newName; });
    });
    username = newName;
    localStorage.setItem(KEY.USERNAME, username);
  }

  if (newAvatarUrl) userData.avatar = newAvatarUrl;
  if (newBio !== userData.bio) userData.bio = newBio;

  localStorage.setItem(KEY.USER, JSON.stringify(userData));
  localStorage.setItem(KEY.POSTS, JSON.stringify(posts));

  alert('–ó–º—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
  updateProfile();
  renderPosts();
});

document.getElementById('themeSelect').addEventListener('change', e => {
  localStorage.setItem('fantasyasTheme', e.target.value);
  applyPreferences();
});

document.getElementById('fontSizeSelect').addEventListener('change', e => {
  localStorage.setItem('fantasyasFontSize', e.target.value);
  applyPreferences();
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  if (confirm('–í–∏–π—Ç–∏?')) {
    localStorage.removeItem(KEY.USERNAME);
    location.reload();
  }
});

document.getElementById('deleteAccountBtn').addEventListener('click', () => {
  if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç? –í—Å—ñ —Ç–≤–æ—ó –ø–æ—Å—Ç–∏ —Ç–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ!')) {
    posts = posts.filter(p => p.username !== username);
    localStorage.removeItem(KEY.USERNAME);
    localStorage.removeItem(KEY.USER);
    savePosts();
    location.reload();
  }
});

document.getElementById('clearAllData').addEventListener('click', () => {
  if (confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –í–°–Ü –¥–∞–Ω—ñ –Ω–∞–∑–∞–≤–∂–¥–∏?')) {
    localStorage.clear();
    location.reload();
  }
});

// –ú–æ–¥–∞–ª–∫–∞
document.getElementById('editProfileBtn').addEventListener('click', () => {
  document.getElementById('editAvatar').value = '';
  document.getElementById('editBio').value = userData.bio || '';
  modal.classList.add('active');
});

document.getElementById('closeModal').addEventListener('click', () => modal.classList.remove('active'));

document.getElementById('saveProfileEdit').addEventListener('click', () => {
  const url = document.getElementById('editAvatar').value.trim();
  const bio = document.getElementById('editBio').value.trim();

  if (url) userData.avatar = url;
  userData.bio = bio;

  localStorage.setItem(KEY.USER, JSON.stringify(userData));
  modal.classList.remove('active');
  updateProfile();
  renderPosts();
  alert('–ü—Ä–æ—Ñ—ñ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ!');
});

function savePosts() {
  localStorage.setItem(KEY.POSTS, JSON.stringify(posts));
}

// –ü–æ—á–∞—Ç–æ–∫
if (username) {
  renderPosts();
  updateProfile();
}
</script>
</body>
</html>
